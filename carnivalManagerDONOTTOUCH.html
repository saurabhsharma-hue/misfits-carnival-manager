<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misfits Carnival Program Manager - FB v2.1.14</title>
    <!-- Version: 2.1.14 - Complete data reset to fix contamination -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS Fix for Dropdown Interaction Issues -->
    <style>
        /* Dashboard sections */
        .dashboard-section {
            display: block;
        }
        .dashboard-section.hidden {
            display: none !important;
        }

        /* Force dropdown interactivity */
        select {
            pointer-events: auto !important;
            z-index: 999 !important;
            position: relative !important;
            cursor: pointer !important;
            -webkit-appearance: menulist !important;
            -moz-appearance: menulist !important;
            appearance: auto !important;
        }

        /* Ensure dropdown arrows are visible */
        select::-ms-expand {
            display: block !important;
        }

        /* Fix for potential overlay issues */
        .view {
            position: relative !important;
            z-index: 1 !important;
        }

        /* Ensure dropdowns can open above other elements */
        select option {
            background-color: white !important;
            color: black !important;
        }
    </style>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration - Real project for team collaboration
        const firebaseConfig = {
            apiKey: "AIzaSyCweHkt882pn_1A-KkEqisYU_YlwOsfFxQ",
            authDomain: "event-management-app-fbbae.firebaseapp.com",
            databaseURL: "https://event-management-app-fbbae-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "event-management-app-fbbae",
            storageBucket: "event-management-app-fbbae.firebasestorage.app",
            messagingSenderId: "924131616519",
            appId: "1:924131616519:web:ad5105519c72963d5ac7a2",
            measurementId: "G-RGBYH07B4G"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions available globally
        window.firebase = {
            database,
            ref,
            set,
            get,
            onValue,
            push,
            update,
            remove
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none !important; }
        .view { display: block; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight">
                üé™ Misfits Carnival Program Manager - FB
            </h1>
            <p class="mt-2 text-lg text-gray-600">
                Complete Task Management System
            </p>
        </header>


        <!-- Navigation Tabs -->
        <nav class="flex space-x-4 border-b border-gray-200 mb-6">
            <button onclick="showView('dashboard')" id="tab-dashboard" class="py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-indigo-600 border-b-2 border-indigo-600">
                Dashboard
            </button>
            <button onclick="showView('task-tracker')" id="tab-task-tracker" class="py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700">
                Task Tracker
            </button>
            <button onclick="showView('timeline')" id="tab-timeline" class="py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700">
                Timeline
            </button>
            <button onclick="showView('setup')" id="tab-setup" class="py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700">
                Setup & Template
            </button>
        </nav>

        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìä Dashboard</h2>

            <!-- Filters -->
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-medium mb-3">Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="dashboard-carnival-filter" class="border rounded-lg px-3 py-2" onchange="renderDashboard()">
                        <option value="all">All Carnivals</option>
                    </select>
                    <select id="dashboard-club-filter" class="border rounded-lg px-3 py-2" onchange="renderDashboard()">
                        <option value="all">All Clubs</option>
                    </select>
                    <select id="dashboard-team-filter" class="border rounded-lg px-3 py-2" onchange="renderDashboard()">
                        <option value="all">All Teams</option>
                    </select>
                    <select id="dashboard-owner-filter" class="border rounded-lg px-3 py-2" onchange="renderDashboard()">
                        <option value="all">All Owners</option>
                    </select>
                    <select id="dashboard-status-filter" class="border rounded-lg px-3 py-2" onchange="renderDashboard()">
                        <option value="all">All Status</option>
                    </select>
                </div>
            </div>

            <!-- Basic Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Total Tasks</h3>
                    <p id="total-tasks-stat" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Completed</h3>
                    <p id="completed-tasks-stat" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Total Revenue</h3>
                    <p id="total-revenue-stat" class="text-3xl font-bold text-green-600">‚Çπ0</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Completion %</h3>
                    <p id="completion-stat" class="text-3xl font-bold text-indigo-600">0%</p>
                </div>
            </div>

            <!-- Dashboard Sections Navigation -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6" aria-label="Dashboard sections">
                        <button onclick="showDashboardSection('overview')" id="section-overview" class="py-4 px-1 border-b-2 border-indigo-500 text-indigo-600 font-medium text-sm whitespace-nowrap">
                            üìä Overall View
                        </button>
                        <button onclick="showDashboardSection('carnivals')" id="section-carnivals" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                            üé™ Carnival Management
                        </button>
                        <button onclick="showDashboardSection('revenue')" id="section-revenue" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                            üí∞ Revenue Tracking
                        </button>
                        <button onclick="showDashboardSection('alerts')" id="section-alerts" class="py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm whitespace-nowrap">
                            üö® Alerts & Actions
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Overall View Section -->
            <div id="dashboard-section-overview" class="dashboard-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Overall Program Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">Active Carnivals</h4>
                            <div id="overview-carnivals" class="space-y-2">
                                <!-- Carnival overview items -->
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">Key Metrics</h4>
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Tasks:</span>
                                    <span id="overview-total-tasks" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Completion Rate:</span>
                                    <span id="overview-completion" class="font-medium">0%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Revenue:</span>
                                    <span id="overview-revenue" class="font-medium">‚Çπ0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Urgent Tasks:</span>
                                    <span id="overview-urgent" class="font-medium text-red-600">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carnival Management Section -->
            <div id="dashboard-section-carnivals" class="dashboard-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">üé™ Carnival Management</h3>
                        <button onclick="toggleAllCarnivals()" class="text-indigo-600 hover:text-indigo-800 text-sm">
                            <span id="toggle-all-text">Expand All</span>
                        </button>
                    </div>
                    <div id="carnival-matrix" class="space-y-4">
                        <!-- Carnival boxes will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Revenue Tracking Section -->
            <div id="dashboard-section-revenue" class="dashboard-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üí∞ Revenue Tracking</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Revenue by Carnival -->
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Revenue by Carnival</h4>
                            <div id="revenue-by-carnival" class="space-y-3">
                                <!-- Revenue items -->
                            </div>
                        </div>
                        <!-- Quick Add Revenue -->
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Quick Add Revenue</h4>
                            <div class="space-y-3">
                                <select id="quick-revenue-carnival" class="w-full px-3 py-2 border rounded-lg" onchange="updateClubDropdown()">
                                    <option value="">Select Carnival</option>
                                </select>
                                <select id="quick-revenue-club" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">Select Club</option>
                                </select>
                                <input type="number" id="quick-revenue-amount" class="w-full px-3 py-2 border rounded-lg" placeholder="Amount (‚Çπ)">
                                <button onclick="quickAddRevenue()" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                    Add Revenue
                                </button>
                            </div>
                        </div>

                        <!-- Revenue Management -->
                        <div>
                            <h4 class="font-medium text-gray-700 mb-3">Manage Revenue Entries</h4>
                            <div class="space-y-3">
                                <select id="manage-revenue-carnival" class="w-full px-3 py-2 border rounded-lg" onchange="loadRevenueEntries()">
                                    <option value="">Select Carnival</option>
                                </select>
                                <div id="revenue-entries-list" class="max-h-64 overflow-y-auto space-y-2">
                                    <p class="text-sm text-gray-500">Select a carnival to view revenue entries</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts & Actions Section -->
            <div id="dashboard-section-alerts" class="dashboard-section hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üö® Alerts & Priority Actions</h3>
                    <div id="alerts-container" class="space-y-4">
                        <!-- Alerts will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Revenue Input Modal -->
            <div id="revenue-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">üí∞ Add Revenue</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Carnival</label>
                            <input type="text" id="revenue-carnival" class="w-full px-3 py-2 border rounded-lg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Club</label>
                            <input type="text" id="revenue-club" class="w-full px-3 py-2 border rounded-lg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Revenue Amount (‚Çπ)</label>
                            <input type="number" id="revenue-amount" class="w-full px-3 py-2 border rounded-lg" placeholder="Enter amount in rupees" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" id="revenue-date" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <input type="text" id="revenue-description" class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Event revenue, Membership fees">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeRevenueModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button onclick="addRevenue()" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            Add Revenue
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Revenue Modal -->
            <div id="edit-revenue-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚úèÔ∏è Edit Revenue Entry</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Amount (‚Çπ)</label>
                            <input type="number" id="edit-revenue-amount" class="w-full px-3 py-2 border rounded-lg" placeholder="Amount">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <input type="text" id="edit-revenue-description" class="w-full px-3 py-2 border rounded-lg" placeholder="Description">
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">
                                <strong>Club:</strong> <span id="edit-revenue-club-name"></span><br>
                                <strong>Added:</strong> <span id="edit-revenue-timestamp"></span>
                            </p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-6">
                        <button onclick="deleteRevenueEntry()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            Delete
                        </button>
                        <button onclick="closeEditRevenueModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button onclick="saveRevenueEdit()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Task Tracker View -->
        <div id="task-tracker-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üéØ Task Tracker</h2>

            <!-- Navigation Breadcrumb -->
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-medium mb-3">Navigation</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select id="tracker-carnival-select" class="border rounded-lg px-3 py-2" onchange="updateTrackerView()">
                        <option value="">Select Carnival to View Tasks</option>
                    </select>
                    <select id="tracker-club-select" class="border rounded-lg px-3 py-2" onchange="renderTaskTracker()">
                        <option value="all">All Clubs</option>
                    </select>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="text-lg font-medium mb-3">Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="tracker-team-filter" class="border rounded-lg px-3 py-2" onchange="renderTaskTracker()">
                        <option value="all">All Teams</option>
                    </select>
                    <select id="tracker-owner-filter" class="border rounded-lg px-3 py-2" onchange="renderTaskTracker()">
                        <option value="all">All Owners</option>
                    </select>
                    <select id="tracker-status-filter" class="border rounded-lg px-3 py-2" onchange="renderTaskTracker()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="tracker-sort-filter" class="border rounded-lg px-3 py-2" onchange="renderTaskTracker()">
                        <option value="urgency">Sort by Timeline Urgency</option>
                        <option value="due-date-asc">Sort by Due Date (Earliest First)</option>
                        <option value="due-date-desc">Sort by Due Date (Latest First)</option>
                        <option value="overdue-first">Overdue Tasks First</option>
                        <option value="completed-last">Completed Tasks Last</option>
                    </select>
                </div>
            </div>

            <!-- Task List -->
            <div id="tracker-task-list" class="space-y-3">
                <!-- Tasks will be rendered here -->
            </div>
        </div>

        <!-- Timeline View -->
        <div id="timeline-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìÖ Timeline</h2>

            <!-- Comprehensive Filters -->
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-lg font-medium mb-4">Timeline Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-4">
                    <select id="timeline-carnival-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Carnivals</option>
                    </select>
                    <select id="timeline-club-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Clubs</option>
                    </select>
                    <select id="timeline-team-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Teams</option>
                    </select>
                    <select id="timeline-owner-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Owners</option>
                    </select>
                    <select id="timeline-status-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in-progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <select id="timeline-period-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Time</option>
                        <option value="upcoming">Next 7 Days</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                        <option value="overdue">Overdue Tasks</option>
                    </select>
                    <select id="timeline-task-type" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="all">All Task Types</option>
                        <option value="carnival">Carnival Tasks</option>
                        <option value="club">Club Tasks</option>
                    </select>
                    <!-- Group filter removed - users want simple filtering, not hierarchical grouping -->
                    <select id="timeline-sort-filter" class="border rounded-lg px-3 py-2" onchange="renderTimeline()">
                        <option value="urgency">Sort by Timeline Urgency</option>
                        <option value="due-date-asc">Sort by Due Date (Earliest First)</option>
                        <option value="due-date-desc">Sort by Due Date (Latest First)</option>
                        <option value="overdue-first">Overdue Tasks First</option>
                        <option value="completed-last">Completed Tasks Last</option>
                    </select>
                </div>

            </div>

            <!-- Timeline Stats Summary -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-sm font-medium text-gray-500">Filtered Tasks</h3>
                    <p id="timeline-total-filtered" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-sm font-medium text-gray-500">Upcoming This Week</h3>
                    <p id="timeline-upcoming-week" class="text-2xl font-bold text-yellow-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-sm font-medium text-gray-500">Overdue</h3>
                    <p id="timeline-overdue" class="text-2xl font-bold text-red-600">0</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <h3 class="text-sm font-medium text-gray-500">Completion Rate</h3>
                    <p id="timeline-completion-rate" class="text-2xl font-bold text-green-600">0%</p>
                </div>
            </div>

            <!-- Timeline Display -->
            <div id="timeline-content" class="space-y-4">
                <!-- Timeline items will be rendered here -->
            </div>
        </div>

        <!-- Setup & Template View -->
        <div id="setup-view" class="view hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">‚öôÔ∏è Setup & Template</h2>

            <!-- Carnival Management -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Carnival Creation -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-4">üé™ Create Carnival</h3>
                    <div class="space-y-4">
                        <input type="text" id="carnival-name-input" placeholder="Carnival Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <textarea id="carnival-description-input" placeholder="Carnival Description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                        <input type="date" id="carnival-start-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <input type="date" id="carnival-end-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <button onclick="createCarnival()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                            Create Carnival
                        </button>
                    </div>
                </div>

                <!-- Club Registration -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-semibold text-green-700 mb-4">üèõÔ∏è Register Club</h3>
                    <div class="space-y-4">
                        <input type="text" id="club-name-input" placeholder="Club Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                        <div>
                            <select id="club-activity-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" onchange="handleActivitySelection()">
                                <option value="">Select Activity</option>
                                <option value="Football">Football</option>
                                <option value="Cricket">Cricket</option>
                                <option value="Basketball">Basketball</option>
                                <option value="Badminton">Badminton</option>
                                <option value="Chess">Chess</option>
                                <option value="Music">Music</option>
                                <option value="Dance">Dance</option>
                                <option value="Art">Art</option>
                                <option value="Drama">Drama</option>
                                <option value="Photography">Photography</option>
                                <option value="custom">+ Add Custom Activity</option>
                            </select>
                            <input type="text" id="custom-activity-input" placeholder="Enter custom activity name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 mt-2 hidden">
                        </div>
                        <select id="club-commission-type" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500" onchange="handleCommissionTypeChange()">
                            <option value="">Commission Type</option>
                            <option value="Percentage">Percentage Based</option>
                            <option value="Fixed">Fixed Amount</option>
                            <option value="Revenue Share">Revenue Share</option>
                        </select>

                        <!-- Commission Amount Input -->
                        <div id="commission-amount-container" class="hidden">
                            <div class="flex items-center">
                                <span id="commission-currency-symbol" class="text-gray-600 mr-2">%</span>
                                <input type="number" id="commission-amount" placeholder="Enter amount"
                                       class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500"
                                       min="0" step="0.01">
                            </div>
                            <p id="commission-help-text" class="text-sm text-gray-500 mt-1">Enter percentage (e.g., 5 for 5%)</p>
                        </div>

                        <!-- Multiple Carnival Selection -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Carnivals (Multiple)</label>
                            <div id="carnival-checkbox-list" class="max-h-40 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                                <p class="text-sm text-gray-500">Create carnivals first to register clubs</p>
                            </div>
                        </div>

                        <button onclick="registerClub()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            Register Club
                        </button>
                    </div>
                </div>
            </div>

            <!-- Task Creation Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold text-purple-700 mb-4">üìù Create New Task</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <select id="task-type-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500" onchange="handleTaskTypeChange()">
                            <option value="">Select Task Type</option>
                            <option value="template">Template Task (applies to all future clubs)</option>
                            <option value="carnival">Carnival-Level Task</option>
                            <option value="club">Club-Specific Task</option>
                        </select>

                        <div id="carnival-select-container" class="hidden">
                            <select id="task-carnival-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Carnival</option>
                            </select>
                        </div>

                        <div id="club-select-container" class="hidden">
                            <select id="task-club-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Club</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <textarea id="task-description-input" placeholder="Task Description" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>

                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="task-team-input" list="team-suggestions" placeholder="Team" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <datalist id="team-suggestions">
                                <option value="Operations">
                                <option value="Marketing">
                                <option value="Finance">
                                <option value="Tech">
                            </datalist>

                            <input type="text" id="task-owner-input" list="owner-suggestions" placeholder="Owner" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <datalist id="owner-suggestions">
                                <option value="Joy">
                                <option value="Ayushi">
                                <option value="Tauheed">
                                <option value="Team Lead">
                            </datalist>
                        </div>

                        <button onclick="createCustomTask()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                            Create Task
                        </button>
                    </div>
                </div>
            </div>

            <!-- Task Template Management -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-indigo-700">üìã Template Tasks (Mandatory for All Clubs)</h3>
                    <button onclick="toggleTemplateExpansion()" class="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg hover:bg-indigo-200 transition-colors">
                        <span id="template-toggle-text">Expand All</span>
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">These tasks are automatically assigned to every new club registration</p>

                <div id="mandatory-task-summary" class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-indigo-800 font-medium">üìä <span id="template-count">19</span> mandatory tasks configured</p>
                    <p class="text-xs text-indigo-600 mt-1">Click "Expand All" to view and edit individual tasks</p>
                </div>

                <div id="task-template-list" class="space-y-3 hidden">
                    <!-- Tasks will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Enhanced Task Details Modal -->
        <div id="task-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">Task Details</h3>
                    <button onclick="closeTaskDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Basic Task Info -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Task Description</label>
                                <textarea id="task-detail-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Team</label>
                                    <select id="task-detail-team" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                        <option value="Operations">Operations</option>
                                        <option value="Marketing">Marketing</option>
                                        <option value="Finance">Finance</option>
                                        <option value="Tech">Tech</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Owner</label>
                                    <input type="text" id="task-detail-owner" list="owner-suggestions-modal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <datalist id="owner-suggestions-modal">
                                        <option value="Joy">
                                        <option value="Ayushi">
                                        <option value="Tauheed">
                                        <option value="Team Lead">
                                    </datalist>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="task-detail-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Expected Date</label>
                                    <input type="date" id="task-detail-expected-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="validateTaskDate('expected')">
                                    <div id="expected-date-error" class="text-red-600 text-xs mt-1 hidden">Expected date cannot be before task creation date</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Actual Date</label>
                                    <input type="date" id="task-detail-actual-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="validateTaskDate('actual')">
                                    <div id="actual-date-error" class="text-red-600 text-xs mt-1 hidden">Actual date cannot be before task creation date</div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Details -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Detailed Notes</label>
                                <textarea id="task-detail-notes" rows="4" placeholder="Add detailed notes, requirements, or updates..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Document Links</label>
                                <div class="space-y-2">
                                    <input type="url" id="task-detail-link1" placeholder="https://docs.google.com/document/..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <input type="url" id="task-detail-link2" placeholder="https://drive.google.com/file/..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <input type="url" id="task-detail-link3" placeholder="https://github.com/repo/..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label>
                                <select id="task-detail-priority" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="low">Low Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="high">High Priority</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Progress (%)</label>
                                <div class="flex items-center space-x-3">
                                    <input type="range" id="task-detail-progress" min="0" max="100" step="5" class="flex-1" oninput="updateProgressDisplay()">
                                    <span id="progress-display" class="text-sm font-medium text-gray-600 w-12">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task Context Info -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-2">Task Context</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-500">Carnival:</span>
                                <span id="task-context-carnival" class="ml-1 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Club:</span>
                                <span id="task-context-club" class="ml-1 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Type:</span>
                                <span id="task-context-type" class="ml-1 font-medium">-</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Created:</span>
                                <span id="task-context-created" class="ml-1 font-medium">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Task Transfer Options -->
                    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <h4 class="font-medium text-purple-800 mb-3">üé™ Transfer Task</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-2">Transfer Options</label>
                                <select id="task-transfer-type" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="updateTransferOptions()">
                                    <option value="">Select transfer option...</option>
                                    <option value="template-to-carnival">Move from Template to Carnival Level</option>
                                    <option value="club-to-carnival">Move from Club to Carnival Level</option>
                                    <option value="carnival-to-club">Move from Carnival to Club Level</option>
                                    <option value="template-to-club">Move from Template to Specific Club</option>
                                </select>
                            </div>

                            <div id="transfer-carnival-section" class="hidden">
                                <label class="block text-sm font-medium text-purple-700 mb-2">Select Carnival</label>
                                <select id="task-transfer-carnival" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Choose carnival...</option>
                                </select>
                            </div>

                            <div id="transfer-club-section" class="hidden">
                                <label class="block text-sm font-medium text-purple-700 mb-2">Select Club</label>
                                <select id="task-transfer-club" class="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Choose club...</option>
                                    <option value="all">All Clubs in Carnival</option>
                                </select>
                            </div>

                            <button id="transfer-action-btn" onclick="executeTaskTransfer()" class="hidden w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                                Execute Transfer
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-between p-6 border-t bg-gray-50">
                    <button onclick="closeTaskDetailsModal()" class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancel
                    </button>
                    <div class="space-x-3">
                        <button onclick="deleteCurrentTask()" class="px-6 py-2 text-sm font-medium text-red-700 bg-red-50 border border-red-300 rounded-lg hover:bg-red-100">
                            Delete Task
                        </button>
                        <button onclick="saveTaskDetails()" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Structure for Multi-Carnival Support
        let carnivalsList = []; // {id, name, description, startDate, endDate, tasks: []}
        let clubsList = []; // {id, name, activity, commissionType, carnivals: []}
        let allTasks = {}; // {carnivalId: {clubId: [tasks], carnivalTasks: [tasks]}}
        let isFirebaseReady = false;

        // Initialize empty data - Firebase only mode
        function initializeSampleData() {
            // Clear all hardcoded data - Firebase only
            carnivalsList = [];
            clubsList = [];
            allTasks = {};

            // Initialize revenue data properly - avoid window references
            revenueData = revenueData || {};

            console.log('‚úÖ Sample data initialized:', { carnivals: carnivalsList.length, tasks: Object.keys(allTasks).length });
        }

        // Real-time collaboration setup (BroadcastChannel for multi-tab sync + Firebase fallback)
        let broadcastChannel;

        // Firebase Database Functions
        async function initializeFirebase() {
            try {
                // Setup local multi-tab synchronization
                setupBroadcastChannel();

                // Wait for Firebase to be available
                while (!window.firebase) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                isFirebaseReady = true;
                console.log('‚úÖ Firebase initialized successfully - Real-time collaboration enabled!');
                updateCollaborationStatus('success', '‚úÖ Firebase real-time collaboration active - All team members sync automatically!', 'üî•');

                // Load data from Firebase
                await loadDataFromFirebase();

                // Set up real-time listeners
                setupRealtimeListeners();

            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase not configured yet. Using localStorage + BroadcastChannel for multi-tab sync:', error);
                isFirebaseReady = false;
                updateCollaborationStatus('warning', 'üì° Multi-tab sync enabled. For full team collaboration, Firebase setup needed.', 'üì°');
                loadFromLocalStorage();
            }
        }

        function setupBroadcastChannel() {
            // Enable multi-tab synchronization
            broadcastChannel = new BroadcastChannel('carnival-manager-sync');

            broadcastChannel.onmessage = (event) => {
                const { type, data } = event.data;

                switch(type) {
                    case 'carnivals-updated':
                        carnivalsList = data;
                        updateAllDropdowns();
                        renderDashboard();
                        console.log('üîÑ Carnivals synced from another tab');
                        showSyncNotification('Carnivals synced from team member');
                        break;
                    case 'clubs-updated':
                        clubsList = data;
                        updateAllDropdowns();
                        renderDashboard();
                        console.log('üîÑ Clubs synced from another tab');
                        showSyncNotification('Clubs synced from team member');
                        break;
                    case 'tasks-updated':
                        allTasks = data;
                        renderDashboard();
                        // Refresh current view
                        const currentView = document.querySelector('.view:not(.hidden)')?.id;
                        if (currentView === 'task-tracker-view') renderTaskTracker();
                        if (currentView === 'timeline-view') renderTimeline();
                        console.log('üîÑ Tasks synced from another tab');
                        showSyncNotification('Tasks synced from team member');
                        break;
                    case 'revenue-updated':
                        revenueData = data;
                        renderDashboard();
                        renderRevenueSection();
                        console.log('üîÑ Revenue synced from another tab');
                        showSyncNotification('Revenue synced from team member');
                        break;
                }
            };

            console.log('üì° Multi-tab synchronization enabled');
        }

        function broadcastUpdate(type, data) {
            if (broadcastChannel) {
                broadcastChannel.postMessage({ type, data });
            }
        }

        function updateCollaborationStatus(status, message, icon = 'üîÑ') {
            // Banner removed for production - no action needed
            return;
        }

        function showSyncNotification(message) {
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300';
            notification.innerHTML = `<div class="flex items-center"><span class="mr-2">üîÑ</span>${message}</div>`;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        async function saveToFirebase(path, data) {
            // Always save to localStorage as backup
            saveToLocalStorage();

            // Broadcast update to other tabs
            broadcastUpdate(path + '-updated', data);

            if (!isFirebaseReady) {
                return;
            }

            try {
                await window.firebase.set(window.firebase.ref(window.firebase.database, path), data);
                console.log(`‚úÖ Data saved to Firebase: ${path}`);
            } catch (error) {
                console.error('‚ùå Firebase save failed:', error);
            }
        }

        async function loadDataFromFirebase() {
            if (!isFirebaseReady) return;

            try {
                // Load carnivals
                const carnivalsSnapshot = await window.firebase.get(window.firebase.ref(window.firebase.database, 'carnivals'));
                if (carnivalsSnapshot.exists()) {
                    carnivalsList = Object.values(carnivalsSnapshot.val()) || [];
                }

                // Load clubs
                const clubsSnapshot = await window.firebase.get(window.firebase.ref(window.firebase.database, 'clubs'));
                if (clubsSnapshot.exists()) {
                    clubsList = Object.values(clubsSnapshot.val()) || [];
                }

                // Load tasks
                const tasksSnapshot = await window.firebase.get(window.firebase.ref(window.firebase.database, 'tasks'));
                if (tasksSnapshot.exists()) {
                    allTasks = tasksSnapshot.val() || {};
                }

                console.log('Data loaded from Firebase');
                updateAllDropdowns();
                renderDashboard();
            } catch (error) {
                console.error('Failed to load from Firebase:', error);
            }
        }

        function setupRealtimeListeners() {
            if (!isFirebaseReady) return;

            // Listen for carnival changes
            window.firebase.onValue(window.firebase.ref(window.firebase.database, 'carnivals'), (snapshot) => {
                if (snapshot.exists()) {
                    carnivalsList = Object.values(snapshot.val()) || [];
                    updateAllDropdowns();
                    renderDashboard();
                }
            });

            // Listen for club changes
            window.firebase.onValue(window.firebase.ref(window.firebase.database, 'clubs'), (snapshot) => {
                if (snapshot.exists()) {
                    clubsList = Object.values(snapshot.val()) || [];
                    updateAllDropdowns();
                    renderDashboard();
                }
            });

            // Listen for task changes
            window.firebase.onValue(window.firebase.ref(window.firebase.database, 'tasks'), (snapshot) => {
                if (snapshot.exists()) {
                    allTasks = snapshot.val() || {};
                    renderDashboard();
                    // Refresh current view if it's tasks-related
                    const currentView = document.querySelector('.view:not(.hidden)')?.id;
                    if (currentView === 'task-tracker-view' || currentView === 'timeline-view') {
                        if (currentView === 'task-tracker-view') renderTaskTracker();
                        if (currentView === 'timeline-view') renderTimeline();
                    }
                }
            });
        }

        function saveToLocalStorage() {
            // Fallback to localStorage if Firebase fails
            localStorage.setItem('carnivalsList', JSON.stringify(carnivalsList));
            localStorage.setItem('clubsList', JSON.stringify(clubsList));
            localStorage.setItem('allTasks', JSON.stringify(allTasks));
            localStorage.setItem('revenueData', JSON.stringify(revenueData));
        }

        function loadFromLocalStorage() {
            // Load from localStorage as fallback
            try {
                const savedCarnivals = localStorage.getItem('carnivalsList');
                const savedClubs = localStorage.getItem('clubsList');
                const savedTasks = localStorage.getItem('allTasks');
                const savedRevenue = localStorage.getItem('revenueData');

                if (savedCarnivals) carnivalsList = JSON.parse(savedCarnivals);
                if (savedClubs) clubsList = JSON.parse(savedClubs);
                if (savedTasks) allTasks = JSON.parse(savedTasks);
                if (savedRevenue) {
                    revenueData = JSON.parse(savedRevenue);
                }

                // No fallback data - Firebase only mode
                // If no data in Firebase, the app will show empty state

                updateAllDropdowns();
                renderDashboard();
            } catch (error) {
                console.error('Failed to load from localStorage:', error);
            }
        }

        // Template tasks (mandatory for all clubs)
        const mandatoryTemplate = [
            { id: 1, description: "Once the leader reverts, event coordinator to sit with them, finalise the dates, event flow and commission %", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 2, description: "Get the venue requested by the venue team and map a venue to the event", team: "Operations", owner: "Tauheed", status: "pending", createdAt: "2025-01-01" },
            { id: 3, description: "Prepare the content plan with marketing team - how much hype to be done, how etc etc and when", team: "Marketing", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 4, description: "Logistical requirement to be taken on a doc by the club and keep it somewhere against the club with the status of what all is done", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 5, description: "Banner to be created by the marketing team - alignment and completion", team: "Marketing", owner: "Ayushi", status: "pending", createdAt: "2025-01-01" },
            { id: 6, description: "Sharing event flow details with marketing team", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 7, description: "Logo to be created by the marketing team - alignment and completion", team: "Marketing", owner: "Ayushi", status: "pending", createdAt: "2025-01-01" },
            { id: 8, description: "Marketing asset requirement - Ideally I should be able to add under this section (Example - medals, certificate, standees)", team: "Marketing", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 9, description: "Banner to be placed in the festival section of the app", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 10, description: "Meetup creation and linking to the festival section", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 11, description: "Asset making by marketing team", team: "Marketing", owner: "Ayushi", status: "pending", createdAt: "2025-01-01" },
            { id: 12, description: "Asset printing", team: "Marketing", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 13, description: "Asset delivery", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 14, description: "Logistical requirement delivery", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 15, description: "Logistical and asset implementation", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 16, description: "Videographer requirement and alignment", team: "Marketing", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 17, description: "Post event content", team: "Marketing", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 18, description: "On ground assistant requirements", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" },
            { id: 19, description: "On ground assistant implementation", team: "Operations", owner: "Joy", status: "pending", createdAt: "2025-01-01" }
        ];

        let taskTemplate = [...mandatoryTemplate]; // Working copy
        let currentEditingIndex = null;
        let templateExpanded = false;
        let nextCarnivalId = 1;
        let nextClubId = 1;

        // Carnival Management Functions
        function createCarnival() {
            const name = document.getElementById('carnival-name-input').value.trim();
            const description = document.getElementById('carnival-description-input').value.trim();
            const startDate = document.getElementById('carnival-start-date').value;
            const endDate = document.getElementById('carnival-end-date').value;

            if (!name) {
                alert('Please enter a carnival name');
                return;
            }

            const carnival = {
                id: nextCarnivalId++,
                name: name,
                description: description,
                startDate: startDate,
                endDate: endDate,
                tasks: []
            };

            carnivalsList.push(carnival);
            allTasks[carnival.id] = { carnivalTasks: [], clubs: {} };

            // Save to Firebase
            saveToFirebase('carnivals', carnivalsList);
            saveToFirebase('tasks', allTasks);

            // Auto-create carnival-level tasks
            const carnivalTasks = [
                { description: "Deciding the fest name which is deciding the carnival name", team: "Operations", owner: "Joy", status: "pending", id: Date.now() },
                { description: "Announcement to leaders group", team: "Operations", owner: "Joy", status: "pending", id: Date.now() + 1 }
            ];
            allTasks[carnival.id].carnivalTasks = carnivalTasks;

            // Save updated tasks to Firebase
            saveToFirebase('tasks', allTasks);

            // Clear inputs
            document.getElementById('carnival-name-input').value = '';
            document.getElementById('carnival-description-input').value = '';
            document.getElementById('carnival-start-date').value = '';
            document.getElementById('carnival-end-date').value = '';

            updateAllDropdowns();
            alert(`Carnival "${name}" created successfully with 2 carnival-level tasks!`);
        }

        function handleActivitySelection() {
            const select = document.getElementById('club-activity-select');
            const customInput = document.getElementById('custom-activity-input');

            if (select.value === 'custom') {
                customInput.classList.remove('hidden');
                customInput.focus();
            } else {
                customInput.classList.add('hidden');
                customInput.value = '';
            }
        }

        function handleCommissionTypeChange() {
            const commissionType = document.getElementById('club-commission-type').value;
            const container = document.getElementById('commission-amount-container');
            const symbol = document.getElementById('commission-currency-symbol');
            const helpText = document.getElementById('commission-help-text');
            const input = document.getElementById('commission-amount');

            if (commissionType) {
                container.classList.remove('hidden');

                switch(commissionType) {
                    case 'Percentage':
                        symbol.textContent = '%';
                        helpText.textContent = 'Enter percentage (e.g., 5 for 5%)';
                        input.placeholder = 'Enter percentage';
                        input.max = '100';
                        break;
                    case 'Fixed':
                        symbol.textContent = '‚Çπ';
                        helpText.textContent = 'Enter fixed amount in rupees';
                        input.placeholder = 'Enter amount';
                        input.max = '';
                        break;
                    case 'Revenue Share':
                        symbol.textContent = '%';
                        helpText.textContent = 'Enter revenue share percentage';
                        input.placeholder = 'Enter percentage';
                        input.max = '100';
                        break;
                }
            } else {
                container.classList.add('hidden');
                input.value = '';
            }
        }

        function registerClub() {
            const name = document.getElementById('club-name-input').value.trim();
            let activity = document.getElementById('club-activity-select').value;
            const commissionType = document.getElementById('club-commission-type').value;
            const commissionAmount = document.getElementById('commission-amount').value;

            // Handle custom activity
            if (activity === 'custom') {
                const customActivity = document.getElementById('custom-activity-input').value.trim();
                if (!customActivity) {
                    alert('Please enter custom activity name');
                    return;
                }
                activity = customActivity;
            }

            if (!name || !activity || !commissionType) {
                alert('Please fill all required fields');
                return;
            }

            // Validate commission amount if commission type is selected
            if (commissionType && !commissionAmount) {
                alert('Please enter commission amount');
                return;
            }

            // Get selected carnivals
            const selectedCarnivals = [];
            const checkboxes = document.querySelectorAll('input[name="carnival-checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedCarnivals.push(parseInt(checkbox.value));
            });

            if (selectedCarnivals.length === 0) {
                alert('Please select at least one carnival');
                return;
            }

            const club = {
                id: nextClubId++,
                name: name,
                activity: activity,
                commissionType: commissionType,
                commissionAmount: commissionAmount,
                carnivals: selectedCarnivals
            };

            clubsList.push(club);

            // Save clubs to Firebase
            saveToFirebase('clubs', clubsList);

            // Create tasks for each carnival
            selectedCarnivals.forEach(carnivalId => {
                if (!allTasks[carnivalId]) {
                    allTasks[carnivalId] = { carnivalTasks: [], clubs: {} };
                }
                // Create deep copies of tasks with unique IDs for this specific club
                allTasks[carnivalId].clubs[club.id] = taskTemplate.map((task, index) => ({
                    ...task,
                    id: `club_${club.id}_carnival_${carnivalId}_task_${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`,
                    clubId: club.id,
                    carnivalId: carnivalId,
                    // Ensure all properties are copied as new values, not references
                    description: task.description,
                    team: task.team,
                    owner: task.owner,
                    status: task.status,
                    createdAt: task.createdAt || new Date().toISOString().split('T')[0]
                }));
            });

            // Save tasks to Firebase
            saveToFirebase('tasks', allTasks);

            // Clear inputs
            document.getElementById('club-name-input').value = '';
            document.getElementById('club-activity-select').value = '';
            document.getElementById('club-commission-type').value = '';
            document.getElementById('commission-amount').value = '';
            document.getElementById('custom-activity-input').value = '';
            document.getElementById('custom-activity-input').classList.add('hidden');
            document.getElementById('commission-amount-container').classList.add('hidden');
            checkboxes.forEach(checkbox => checkbox.checked = false);

            updateAllDropdowns();
            alert(`Club "${name}" registered successfully for ${selectedCarnivals.length} carnival(s) with ${taskTemplate.length} tasks each!`);
        }

        function handleTaskTypeChange() {
            const taskType = document.getElementById('task-type-select').value;
            const carnivalContainer = document.getElementById('carnival-select-container');
            const clubContainer = document.getElementById('club-select-container');

            // Hide all conditional containers
            carnivalContainer.classList.add('hidden');
            clubContainer.classList.add('hidden');

            if (taskType === 'carnival' || taskType === 'club') {
                carnivalContainer.classList.remove('hidden');
                updateCarnivalDropdown('task-carnival-select');
            }

            if (taskType === 'club') {
                clubContainer.classList.remove('hidden');
            }
        }

        function createCustomTask() {
            const taskType = document.getElementById('task-type-select').value;
            const description = document.getElementById('task-description-input').value.trim();
            const team = document.getElementById('task-team-input').value.trim();
            const owner = document.getElementById('task-owner-input').value.trim();

            if (!taskType || !description || !team || !owner) {
                alert('Please fill all required fields');
                return;
            }

            const task = {
                description: description,
                team: team,
                owner: owner,
                status: 'pending',
                id: Date.now(),
                createdAt: new Date().toLocaleDateString(),
                priority: 'medium',
                progress: 0
            };

            if (taskType === 'template') {
                taskTemplate.push(task);
                alert('Template task added! This will be assigned to all future club registrations.');
            } else if (taskType === 'carnival') {
                const carnivalId = parseInt(document.getElementById('task-carnival-select').value);
                if (!carnivalId) {
                    alert('Please select a carnival');
                    return;
                }
                allTasks[carnivalId].carnivalTasks.push(task);
                alert('Carnival-level task created successfully!');
            } else if (taskType === 'club') {
                const carnivalId = parseInt(document.getElementById('task-carnival-select').value);
                const clubId = parseInt(document.getElementById('task-club-select').value);
                if (!carnivalId || !clubId) {
                    alert('Please select both carnival and club');
                    return;
                }
                if (!allTasks[carnivalId].clubs[clubId]) {
                    allTasks[carnivalId].clubs[clubId] = [];
                }
                allTasks[carnivalId].clubs[clubId].push(task);
                alert('Club-specific task created successfully!');
            }

            // Clear form
            document.getElementById('task-type-select').value = '';
            document.getElementById('task-description-input').value = '';
            document.getElementById('task-team-input').value = '';
            document.getElementById('task-owner-input').value = '';
            handleTaskTypeChange();
            updateAllDropdowns();
        }

        function toggleTemplateExpansion() {
            templateExpanded = !templateExpanded;
            const templateList = document.getElementById('task-template-list');
            const toggleText = document.getElementById('template-toggle-text');

            if (templateExpanded) {
                templateList.classList.remove('hidden');
                toggleText.textContent = 'Collapse';
                renderTaskTemplate();
            } else {
                templateList.classList.add('hidden');
                toggleText.textContent = 'Expand All';
            }
        }

        // Dropdown Update Functions
        function updateAllDropdowns() {
            updateCarnivalDropdown('dashboard-carnival-filter');
            updateCarnivalDropdown('task-carnival-select');
            updateClubDropdown('dashboard-club-filter');
            updateClubDropdown('task-club-select');
            updateCarnivalCheckboxes();
            updateTeamOwnerSuggestions();
            updateTemplateCount();

            // Update revenue management dropdowns
            updateRevenueDropdowns();
        }

        function updateCarnivalDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = selectId.includes('filter') ? '<option value="all">All Carnivals</option>' : '<option value="">Select Carnival</option>';

            carnivalsList.forEach(carnival => {
                const option = document.createElement('option');
                option.value = carnival.id;
                option.textContent = carnival.name;
                select.appendChild(option);
            });

            if (currentValue) select.value = currentValue;

            // Update club dropdown when carnival changes
            if (selectId === 'task-carnival-select') {
                select.onchange = () => updateClubDropdown('task-club-select');
            }
        }

        function updateClubDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            const currentValue = select.value;
            select.innerHTML = selectId.includes('filter') ? '<option value="all">All Clubs</option>' : '<option value="">Select Club</option>';

            let clubsToShow = clubsList;

            // Filter clubs based on selected carnival for task creation
            if (selectId === 'task-club-select') {
                const selectedCarnival = parseInt(document.getElementById('task-carnival-select').value);
                if (selectedCarnival) {
                    clubsToShow = clubsList.filter(club => club.carnivals.includes(selectedCarnival));
                }
            }

            clubsToShow.forEach(club => {
                const option = document.createElement('option');
                option.value = club.id;
                option.textContent = `${club.name} (${club.activity})`;
                select.appendChild(option);
            });

            if (currentValue) select.value = currentValue;
        }

        function updateCarnivalCheckboxes() {
            const container = document.getElementById('carnival-checkbox-list');
            if (!container) return;

            if (carnivalsList.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500">Create carnivals first to register clubs</p>';
                return;
            }

            const html = carnivalsList.map(carnival => `
                <label class="flex items-center space-x-2 mb-2">
                    <input type="checkbox" name="carnival-checkbox" value="${carnival.id}" class="form-checkbox h-4 w-4 text-indigo-600">
                    <span class="text-sm text-gray-700">${carnival.name}</span>
                </label>
            `).join('');

            container.innerHTML = html;
        }

        function updateTeamOwnerSuggestions() {
            const allTasksFlat = getAllTasksFlat();

            // Update team suggestions
            const teams = new Set(['Operations', 'Marketing', 'Finance', 'Tech']);
            allTasksFlat.forEach(task => {
                if (task.team) teams.add(task.team);
            });

            const teamDatalist = document.getElementById('team-suggestions');
            teamDatalist.innerHTML = Array.from(teams).map(team => `<option value="${team}">`).join('');

            // Update owner suggestions
            const owners = new Set(['Joy', 'Ayushi', 'Tauheed', 'Team Lead']);
            allTasksFlat.forEach(task => {
                if (task.owner) owners.add(task.owner);
            });

            const ownerDatalist = document.getElementById('owner-suggestions');
            ownerDatalist.innerHTML = Array.from(owners).map(owner => `<option value="${owner}">`).join('');
        }

        function updateTemplateCount() {
            const templateCountEl = document.getElementById('template-count');
            if (templateCountEl) templateCountEl.textContent = taskTemplate.length;
        }

        function getAllTasksFlat() {
            const tasks = [...taskTemplate];

            Object.values(allTasks).forEach(carnival => {
                tasks.push(...carnival.carnivalTasks);
                Object.values(carnival.clubs).forEach(clubTasks => {
                    tasks.push(...clubTasks);
                });
            });

            return tasks;
        }

        // Navigation function
        function showView(viewId) {
            // Hide all views
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('task-tracker-view').classList.add('hidden');
            document.getElementById('timeline-view').classList.add('hidden');
            document.getElementById('setup-view').classList.add('hidden');

            // Show target view
            document.getElementById(viewId + '-view').classList.remove('hidden');

            // Update tab styles
            document.getElementById('tab-dashboard').className = 'py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700';
            document.getElementById('tab-task-tracker').className = 'py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700';
            document.getElementById('tab-timeline').className = 'py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700';
            document.getElementById('tab-setup').className = 'py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-gray-500 hover:text-gray-700';

            document.getElementById('tab-' + viewId).className = 'py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-200 text-indigo-600 border-b-2 border-indigo-600';

            // Render content based on view
            if (viewId === 'setup') {
                updateAllDropdowns();
                if (templateExpanded) renderTaskTemplate();
            } else if (viewId === 'task-tracker') {
                updateAllDropdowns();
                updateTrackerDropdowns();
                renderTaskTracker();
            } else if (viewId === 'timeline') {
                updateAllDropdowns();
                renderTimeline();
            } else if (viewId === 'dashboard') {
                renderDashboard();
            }
        }

        // Render task template in setup view
        function renderTaskTemplate() {
            const container = document.getElementById('task-template-list');
            if (!container) return;

            const html = taskTemplate.map((task, index) => {
                return `<div class="flex items-center justify-between p-3 bg-gray-50 border rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex-1">
                        <p class="text-sm text-gray-800 font-medium">${task.description}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-xs text-blue-700 bg-blue-100 px-2 py-1 rounded-full">${task.team || 'N/A'}</span>
                        <span class="text-xs text-indigo-700 bg-indigo-100 px-2 py-1 rounded-full">${task.owner || 'N/A'}</span>
                        <span class="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full">Mandatory</span>
                        <button onclick="openTaskDetails('${task.id}', null, null)" class="text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100" title="Edit Task">‚úèÔ∏è</button>
                        <button onclick="deleteTask(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100" title="Delete Task">üóëÔ∏è</button>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
        }

        // Dashboard Dropdown Functions
        function updateDashboardDropdowns() {
            console.log('üîÑ Updating Dashboard dropdowns');
            try {
                // Save current filter values before updating dropdowns
                const currentFilters = {
                    carnival: document.getElementById('dashboard-carnival-filter')?.value,
                    club: document.getElementById('dashboard-club-filter')?.value,
                    team: document.getElementById('dashboard-team-filter')?.value,
                    owner: document.getElementById('dashboard-owner-filter')?.value,
                    status: document.getElementById('dashboard-status-filter')?.value
                };

                // Use same data approach as Timeline (working approach)
                const teams = new Set(['Operations', 'Marketing', 'Finance', 'Tech']);
                const owners = new Set(['Joy', 'Ayushi', 'Tauheed', 'Team Lead']);
                const statuses = new Set(['Pending', 'In Progress', 'Completed', 'Done', 'Blocked']);

                // Collect teams and owners from actual task data
                carnivalsList.forEach(carnival => {
                    const carnivalData = allTasks[carnival.id];
                    if (!carnivalData) return;

                    // Get teams/owners from carnival tasks
                    const carnivalTasks = carnivalData.carnivalTasks || [];
                    carnivalTasks.forEach(task => {
                        if (task.team) teams.add(task.team);
                        if (task.owner) owners.add(task.owner);
                        if (task.status) statuses.add(task.status);
                    });

                    // Get teams/owners from club tasks
                    const clubs = clubsList.filter(club => club.carnivals.includes(carnival.id));
                    clubs.forEach(club => {
                        const clubTasks = carnivalData.clubs[club.id] || [];
                        clubTasks.forEach(task => {
                            if (task.team) teams.add(task.team);
                            if (task.owner) owners.add(task.owner);
                            if (task.status) statuses.add(task.status);
                        });
                    });
                });

                // Update team filter
                const teamFilter = document.getElementById('dashboard-team-filter');
                if (teamFilter) {
                    teamFilter.innerHTML = '<option value="all">All Teams</option>';
                    Array.from(teams).sort().forEach(team => {
                        const option = document.createElement('option');
                        option.value = team;
                        option.textContent = team;
                        teamFilter.appendChild(option);
                    });
                }

                // Update owner filter
                const ownerFilter = document.getElementById('dashboard-owner-filter');
                if (ownerFilter) {
                    ownerFilter.innerHTML = '<option value="all">All Owners</option>';
                    Array.from(owners).sort().forEach(owner => {
                        const option = document.createElement('option');
                        option.value = owner;
                        option.textContent = owner;
                        ownerFilter.appendChild(option);
                    });
                }

                // Update status filter
                const statusFilter = document.getElementById('dashboard-status-filter');
                if (statusFilter) {
                    statusFilter.innerHTML = '<option value="all">All Status</option>';
                    const statuses = ['pending', 'in-progress', 'completed'];
                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status === 'in-progress' ? 'In Progress' : status.charAt(0).toUpperCase() + status.slice(1);
                        statusFilter.appendChild(option);
                    });
                }

                // Restore filter values after dropdown update
                if (currentFilters.carnival && document.getElementById('dashboard-carnival-filter')) {
                    document.getElementById('dashboard-carnival-filter').value = currentFilters.carnival;
                }
                if (currentFilters.club && document.getElementById('dashboard-club-filter')) {
                    document.getElementById('dashboard-club-filter').value = currentFilters.club;
                }
                if (currentFilters.team && document.getElementById('dashboard-team-filter')) {
                    document.getElementById('dashboard-team-filter').value = currentFilters.team;
                }
                if (currentFilters.owner && document.getElementById('dashboard-owner-filter')) {
                    document.getElementById('dashboard-owner-filter').value = currentFilters.owner;
                }
                if (currentFilters.status && document.getElementById('dashboard-status-filter')) {
                    document.getElementById('dashboard-status-filter').value = currentFilters.status;
                }

                console.log('‚úÖ Dashboard dropdowns updated successfully');

            } catch (error) {
                console.error('‚ùå Error updating dashboard dropdowns:', error);
            }
        }

        // Update tracker dropdowns
        function updateTrackerDropdowns() {
            // Update carnival dropdown
            const carnivalSelect = document.getElementById('tracker-carnival-select');
            carnivalSelect.innerHTML = '<option value="">Select Carnival to View Tasks</option>';
            carnivalsList.forEach(carnival => {
                const option = document.createElement('option');
                option.value = carnival.id;
                option.textContent = carnival.name;
                carnivalSelect.appendChild(option);
            });

            // Update team and owner filters
            const allTasks = getAllTasksFlat();
            const teams = new Set(['Operations', 'Marketing', 'Finance', 'Tech']);
            const owners = new Set(['Joy', 'Ayushi', 'Tauheed', 'Team Lead']);

            allTasks.forEach(task => {
                if (task.team) teams.add(task.team);
                if (task.owner) owners.add(task.owner);
            });

            const teamFilter = document.getElementById('tracker-team-filter');
            teamFilter.innerHTML = '<option value="all">All Teams</option>';
            Array.from(teams).sort().forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });

            const ownerFilter = document.getElementById('tracker-owner-filter');
            ownerFilter.innerHTML = '<option value="all">All Owners</option>';
            Array.from(owners).sort().forEach(owner => {
                const option = document.createElement('option');
                option.value = owner;
                option.textContent = owner;
                ownerFilter.appendChild(option);
            });
        }

        function updateTrackerView() {
            console.log('üîç Task Tracker filters triggered');
            const selectedCarnival = parseInt(document.getElementById('tracker-carnival-select').value);
            const clubSelect = document.getElementById('tracker-club-select');

            // Update club dropdown based on selected carnival
            if (selectedCarnival) {
                const clubs = clubsList.filter(club => club.carnivals.includes(selectedCarnival));
                clubSelect.innerHTML = '<option value="all">All Clubs in Carnival</option>';
                clubs.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.id;
                    option.textContent = `${club.name} (${club.activity})`;
                    clubSelect.appendChild(option);
                });
            } else {
                clubSelect.innerHTML = '<option value="all">Select Carnival First</option>';
            }

            renderTaskTracker();
        }

        // Render task tracker with filtering
        function renderTaskTracker() {
            console.log('üìã Rendering Task Tracker view');
            const container = document.getElementById('tracker-task-list');
            if (!container) return;

            const selectedCarnival = parseInt(document.getElementById('tracker-carnival-select').value);
            const selectedClub = document.getElementById('tracker-club-select').value;
            const teamFilter = document.getElementById('tracker-team-filter').value;
            const ownerFilter = document.getElementById('tracker-owner-filter').value;
            const statusFilter = document.getElementById('tracker-status-filter').value;
            const sortFilter = document.getElementById('tracker-sort-filter').value;

            console.log('üìã Task Tracker Filters:', {
                carnival: selectedCarnival,
                club: selectedClub,
                team: teamFilter,
                owner: ownerFilter,
                status: statusFilter,
                sort: sortFilter
            });

            let html = '';

            if (carnivalsList.length === 0) {
                html = `<div class="bg-yellow-50 border border-yellow-200 p-6 rounded-lg text-center">
                    <h3 class="text-lg font-medium text-yellow-800 mb-2">No Carnivals Created Yet</h3>
                    <p class="text-yellow-700">Create carnivals and register clubs in the Setup tab to start tracking tasks.</p>
                </div>`;
            } else if (!selectedCarnival) {
                html = `<div class="bg-blue-50 border border-blue-200 p-6 rounded-lg text-center">
                    <h3 class="text-lg font-medium text-blue-800 mb-2">Select a Carnival</h3>
                    <p class="text-blue-700">Choose a carnival from the dropdown above to view its tasks.</p>
                </div>`;
            } else {
                const carnival = carnivalsList.find(c => c.id === selectedCarnival);
                const carnivalTasks = allTasks[selectedCarnival]?.carnivalTasks || [];
                const clubs = clubsList.filter(club => club.carnivals.includes(selectedCarnival));

                // Timeline intelligence for Task Tracker
                const getTaskTimelineInfo = (task) => {
                    if (!task.expectedDate) return { status: 'no-date', urgency: 999, color: 'gray' };

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const dueDate = new Date(task.expectedDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

                    // Check if task is completed (status OR has actual completion date)
                    const isCompleted = task.status === 'Completed' || task.status === 'completed' || task.actualDate;
                    if (isCompleted) return { status: 'completed', urgency: 1000, color: 'green', daysDiff };

                    if (daysDiff < 0) return { status: 'overdue', urgency: Math.abs(daysDiff), color: 'red', daysDiff };
                    if (daysDiff === 0) return { status: 'due-today', urgency: 10, color: 'red', daysDiff };
                    if (daysDiff <= 2) return { status: 'due-soon', urgency: 50 - daysDiff, color: 'orange', daysDiff };
                    if (daysDiff <= 7) return { status: 'due-this-week', urgency: 100 - daysDiff, color: 'yellow', daysDiff };
                    return { status: 'upcoming', urgency: 500 - Math.min(daysDiff, 400), color: 'blue', daysDiff };
                };

                // Filter tasks
                const filterTasks = (tasks) => {
                    return tasks.filter(task => {
                        if (teamFilter !== 'all' && task.team !== teamFilter) return false;
                        if (ownerFilter !== 'all' && task.owner !== ownerFilter) return false;
                        if (statusFilter !== 'all' && task.status !== statusFilter) return false;
                        return true;
                    });
                };

                // Sort tasks
                const sortTasks = (tasks) => {
                    if (!sortFilter || sortFilter === '') return tasks;

                    return tasks.sort((a, b) => {
                        const aInfo = getTaskTimelineInfo(a);
                        const bInfo = getTaskTimelineInfo(b);

                        switch (sortFilter) {
                            case 'urgency':
                                return aInfo.urgency - bInfo.urgency;
                            case 'due-date-asc':
                                if (!a.expectedDate && !b.expectedDate) return 0;
                                if (!a.expectedDate) return 1;
                                if (!b.expectedDate) return -1;
                                return new Date(a.expectedDate) - new Date(b.expectedDate);
                            case 'due-date-desc':
                                if (!a.expectedDate && !b.expectedDate) return 0;
                                if (!a.expectedDate) return 1;
                                if (!b.expectedDate) return -1;
                                return new Date(b.expectedDate) - new Date(a.expectedDate);
                            case 'overdue-first':
                                if (aInfo.status === 'overdue' && bInfo.status !== 'overdue') return -1;
                                if (aInfo.status !== 'overdue' && bInfo.status === 'overdue') return 1;
                                return aInfo.urgency - bInfo.urgency;
                            case 'completed-last':
                                if (aInfo.status === 'completed' && bInfo.status !== 'completed') return 1;
                                if (aInfo.status !== 'completed' && bInfo.status === 'completed') return -1;
                                return aInfo.urgency - bInfo.urgency;
                            default:
                                return 0;
                        }
                    });
                };

                html += `<div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-4">üé™ ${carnival.name}</h3>`;

                // Carnival-level tasks
                const filteredCarnivalTasks = sortTasks(filterTasks(carnivalTasks));
                if (filteredCarnivalTasks.length > 0) {
                    html += `<div class="mb-6">
                        <h4 class="text-md font-medium text-purple-700 mb-3">Carnival-Level Tasks (${filteredCarnivalTasks.length})</h4>
                        <div class="space-y-3">
                            ${filteredCarnivalTasks.map(task => {
                                const timelineInfo = getTaskTimelineInfo(task);
                                const getTimelineDisplay = () => {
                                    if (timelineInfo.status === 'no-date') return '';
                                    if (timelineInfo.status === 'completed') return `<div class="mt-2 p-2 bg-green-100 border-l-4 border-green-500 rounded text-xs text-green-800"><strong>‚úÖ Completed</strong></div>`;
                                    if (timelineInfo.status === 'overdue') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üö® ${Math.abs(timelineInfo.daysDiff)} days overdue</strong></div>`;
                                    if (timelineInfo.status === 'due-today') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üéØ Due Today</strong></div>`;
                                    if (timelineInfo.status === 'due-soon') return `<div class="mt-2 p-2 bg-orange-100 border-l-4 border-orange-500 rounded text-xs text-orange-800"><strong>‚è∞ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                    if (timelineInfo.status === 'due-this-week') return `<div class="mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 rounded text-xs text-yellow-800"><strong>üìÖ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                    return `<div class="mt-2 p-2 bg-blue-100 border-l-4 border-blue-500 rounded text-xs text-blue-800"><strong>üìã ${timelineInfo.daysDiff} days remaining</strong></div>`;
                                };

                                return `
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${selectedCarnival}', null)">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.owner}</span>
                                            <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${task.status}</span>
                                            ${task.expectedDate ? `<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>` : ''}
                                        </div>
                                        ${getTimelineDisplay()}
                                    </div>
                                    <button class="text-indigo-500 hover:text-indigo-700 p-1 rounded" title="View Details">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            `;
                            }).join('')}
                        </div>
                    </div>`;
                }

                // Club tasks
                if (selectedClub === 'all' || selectedClub === '') {
                    // Show all clubs
                    html += `<div><h4 class="text-md font-medium text-green-700 mb-3">Club Tasks</h4>`;
                    clubs.forEach(club => {
                        const clubTasks = allTasks[selectedCarnival]?.clubs[club.id] || [];
                        const filteredClubTasks = sortTasks(filterTasks(clubTasks));

                        if (filteredClubTasks.length > 0) {
                            html += `<div class="mb-4 bg-green-50 p-4 rounded-lg border border-green-200">
                                <h5 class="font-medium text-gray-900 mb-3">${club.name} (${club.activity}) - ${filteredClubTasks.length} tasks</h5>
                                <div class="space-y-2">
                                    ${filteredClubTasks.map(task => {
                                        const timelineInfo = getTaskTimelineInfo(task);
                                        const getTimelineDisplay = () => {
                                            if (timelineInfo.status === 'no-date') return '';
                                            if (timelineInfo.status === 'completed') return `<div class="mt-2 p-2 bg-green-100 border-l-4 border-green-500 rounded text-xs text-green-800"><strong>‚úÖ Completed</strong></div>`;
                                            if (timelineInfo.status === 'overdue') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üö® ${Math.abs(timelineInfo.daysDiff)} days overdue</strong></div>`;
                                            if (timelineInfo.status === 'due-today') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üéØ Due Today</strong></div>`;
                                            if (timelineInfo.status === 'due-soon') return `<div class="mt-2 p-2 bg-orange-100 border-l-4 border-orange-500 rounded text-xs text-orange-800"><strong>‚è∞ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                            if (timelineInfo.status === 'due-this-week') return `<div class="mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 rounded text-xs text-yellow-800"><strong>üìÖ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                            return `<div class="mt-2 p-2 bg-blue-100 border-l-4 border-blue-500 rounded text-xs text-blue-800"><strong>üìã ${timelineInfo.daysDiff} days remaining</strong></div>`;
                                        };

                                        return `
                                    <div class="bg-white p-3 rounded border hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${selectedCarnival}', '${club.id}')">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.owner}</span>
                                                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${task.status}</span>
                                                    ${task.expectedDate ? `<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>` : ''}
                                                </div>
                                                ${getTimelineDisplay()}
                                            </div>
                                            <button class="text-indigo-500 hover:text-indigo-700 p-1 rounded" title="View Details">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>`;
                        }
                    });
                    html += `</div>`;
                } else {
                    // Show specific club
                    const selectedClubId = parseInt(selectedClub);
                    const club = clubs.find(c => c.id === selectedClubId);
                    if (club) {
                        const clubTasks = allTasks[selectedCarnival]?.clubs[selectedClubId] || [];
                        const filteredClubTasks = sortTasks(filterTasks(clubTasks));

                        html += `<div><h4 class="text-md font-medium text-green-700 mb-3">${club.name} Tasks (${filteredClubTasks.length})</h4>
                            <div class="space-y-3">
                                ${filteredClubTasks.map(task => `
                                <div class="bg-green-50 p-4 rounded-lg border border-green-200 hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${selectedCarnival}', '${selectedClubId}')">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                            <div class="flex items-center space-x-2 mb-2">
                                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.owner}</span>
                                                <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${task.status}</span>
                                                ${task.expectedDate ? `<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>` : ''}
                                            </div>
                                            ${(() => {
                                                const timelineInfo = getTaskTimelineInfo(task);
                                                if (timelineInfo.status === 'no-date') return '';
                                                if (timelineInfo.status === 'completed') return `<div class="mt-2 p-2 bg-green-100 border-l-4 border-green-500 rounded text-xs text-green-800"><strong>‚úÖ Completed</strong></div>`;
                                                if (timelineInfo.status === 'overdue') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üö® ${Math.abs(timelineInfo.daysDiff)} days overdue</strong></div>`;
                                                if (timelineInfo.status === 'due-today') return `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 rounded text-xs text-red-800"><strong>üéØ Due Today</strong></div>`;
                                                if (timelineInfo.status === 'due-soon') return `<div class="mt-2 p-2 bg-orange-100 border-l-4 border-orange-500 rounded text-xs text-orange-800"><strong>‚è∞ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                                if (timelineInfo.status === 'due-this-week') return `<div class="mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 rounded text-xs text-yellow-800"><strong>üìÖ Due in ${timelineInfo.daysDiff} days</strong></div>`;
                                                return `<div class="mt-2 p-2 bg-blue-100 border-l-4 border-blue-500 rounded text-xs text-blue-800"><strong>üìã ${timelineInfo.daysDiff} days remaining</strong></div>`;
                                            })()}
                                        </div>
                                        <button class="text-indigo-500 hover:text-indigo-700 p-1 rounded" title="View Details">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                        </div>`;
                    }
                }

                html += `</div>`;
            }

            container.innerHTML = html;
        }

        // Update timeline dropdowns and filters
        function updateTimelineDropdowns() {
            console.log('üîÑ updateTimelineDropdowns called');
            try {
                // Use same data approach as getFilteredTimelineTasks (working approach)
                const teams = new Set(['Operations', 'Marketing', 'Finance', 'Tech']);
                const owners = new Set(['Joy', 'Ayushi', 'Tauheed', 'Team Lead']);
                const statuses = new Set(['Pending', 'In Progress', 'Completed', 'Done', 'Blocked']);

                console.log('üìã Initial teams:', Array.from(teams));
                console.log('üìã Initial owners:', Array.from(owners));
                console.log('üìã Carnivals list:', carnivalsList.length);
                console.log('üìã Clubs list:', clubsList.length);

                // Collect teams and owners from actual task data (same approach as filtering)
                carnivalsList.forEach(carnival => {
                    const carnivalData = allTasks[carnival.id];
                    if (!carnivalData) {
                        console.log(`‚ùå No carnival data for ${carnival.id}`);
                        return;
                    }

                    console.log(`‚úÖ Processing carnival ${carnival.id} (${carnival.name})`);

                    // Get teams/owners from carnival tasks
                    const carnivalTasks = carnivalData.carnivalTasks || [];
                    console.log(`üìã Carnival tasks: ${carnivalTasks.length}`);
                    carnivalTasks.forEach(task => {
                        if (task.team) teams.add(task.team);
                        if (task.owner) owners.add(task.owner);
                        if (task.status) statuses.add(task.status);
                    });

                    // Get teams/owners from club tasks
                    const clubs = clubsList.filter(club => club.carnivals.includes(carnival.id));
                    console.log(`üìã Clubs for carnival ${carnival.id}: ${clubs.length}`);
                    clubs.forEach(club => {
                        const clubTasks = carnivalData.clubs[club.id] || [];
                        console.log(`üìã Club ${club.id} tasks: ${clubTasks.length}`);
                        clubTasks.forEach(task => {
                            if (task.team) teams.add(task.team);
                            if (task.owner) owners.add(task.owner);
                            if (task.status) statuses.add(task.status);
                        });
                    });
                });

                console.log('üìã Final teams collected:', Array.from(teams));
                console.log('üìã Final owners collected:', Array.from(owners));

                // Update carnival filter
                console.log('üîÑ Updating carnival filter');
                const carnivalFilter = document.getElementById('timeline-carnival-filter');
                if (!carnivalFilter) {
                    console.error('‚ùå Carnival filter element not found!');
                    return;
                }
                carnivalFilter.innerHTML = '<option value="all">All Carnivals</option>';
                carnivalsList.forEach(carnival => {
                    const option = document.createElement('option');
                    option.value = carnival.id;
                    option.textContent = carnival.name;
                    carnivalFilter.appendChild(option);
                });
                console.log(`‚úÖ Carnival filter updated with ${carnivalsList.length} options`);

                // Update club filter
                console.log('üîÑ Updating club filter');
                const clubFilter = document.getElementById('timeline-club-filter');
                if (!clubFilter) {
                    console.error('‚ùå Club filter element not found!');
                    return;
                }
                clubFilter.innerHTML = '<option value="all">All Clubs</option>';
                clubsList.forEach(club => {
                    const option = document.createElement('option');
                    option.value = club.id;
                    option.textContent = `${club.name} (${club.activity})`;
                    clubFilter.appendChild(option);
                });
                console.log(`‚úÖ Club filter updated with ${clubsList.length} options`);

                // Update team filter
                console.log('üîÑ Updating team filter');
                const teamFilter = document.getElementById('timeline-team-filter');
                if (!teamFilter) {
                    console.error('‚ùå Team filter element not found!');
                    return;
                }
                teamFilter.innerHTML = '<option value="all">All Teams</option>';
                const teamsArray = Array.from(teams).sort();
                console.log('üìã Teams to add:', teamsArray);
                teamsArray.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamFilter.appendChild(option);
                });
                console.log(`‚úÖ Team filter updated with ${teamsArray.length} options`);

                // Update owner filter
                console.log('üîÑ Updating owner filter');
                const ownerFilter = document.getElementById('timeline-owner-filter');
                if (!ownerFilter) {
                    console.error('‚ùå Owner filter element not found!');
                    return;
                }
                ownerFilter.innerHTML = '<option value="all">All Owners</option>';
                const ownersArray = Array.from(owners).sort();
                console.log('üìã Owners to add:', ownersArray);
                ownersArray.forEach(owner => {
                    const option = document.createElement('option');
                    option.value = owner;
                    option.textContent = owner;
                    ownerFilter.appendChild(option);
                });
                console.log(`‚úÖ Owner filter updated with ${ownersArray.length} options`);

                // Update status filter (was missing!)
                console.log('üîÑ Updating status filter');
                const statusFilter = document.getElementById('timeline-status-filter');
                if (!statusFilter) {
                    console.error('‚ùå Status filter element not found!');
                    return;
                }
                statusFilter.innerHTML = '<option value="all">All Status</option>';
                const statusesArray = Array.from(statuses).sort();
                console.log('üìã Statuses to add:', statusesArray);
                statusesArray.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    statusFilter.appendChild(option);
                });
                console.log(`‚úÖ Status filter updated with ${statusesArray.length} options`);

                console.log('‚úÖ updateTimelineDropdowns completed successfully');

            } catch (error) {
                console.error('‚ùå Error in updateTimelineDropdowns:', error);
            }
        }

        function updateTimelineView() {
            console.log('üîç Timeline filters triggered');
            // Simplified Timeline - just re-render with current filters
            renderTimeline();
        }

        function getFilteredTimelineTasks() {
            console.log('üîç ===== getFilteredTimelineTasks START =====');

            // TEMP DEBUG: Return all tasks without filtering to test rendering
            if (false) {  // Change to false to enable normal filtering
                console.log('üö® BYPASS MODE: Returning all tasks without filtering');
                const allTasksList = [];

                carnivalsList.forEach(carnival => {
                    const carnivalData = allTasks[carnival.id];
                    if (carnivalData) {
                        // Add all carnival tasks
                        (carnivalData.carnivalTasks || []).forEach(task => {
                            allTasksList.push({...task, carnivalId: carnival.id, carnivalName: carnival.name, taskType: 'carnival'});
                        });

                        // Add all club tasks
                        clubsList.filter(club => club.carnivals.includes(carnival.id)).forEach(club => {
                            (carnivalData.clubs[club.id] || []).forEach(task => {
                                allTasksList.push({...task, carnivalId: carnival.id, carnivalName: carnival.name, clubId: club.id, clubName: club.name, taskType: 'club'});
                            });
                        });
                    }
                });

                console.log(`üö® BYPASS RESULT: ${allTasksList.length} tasks`);
                console.log('üîç ===== getFilteredTimelineTasks END (BYPASS) =====');
                return allTasksList;
            }

            // Debug: Check basic data availability
            console.log('üìä Data Check:');
            console.log('  carnivalsList.length:', carnivalsList.length);
            console.log('  clubsList.length:', clubsList.length);
            console.log('  allTasks keys:', Object.keys(allTasks));

            // Use EXACT same approach as Task Tracker - simple and reliable
            const allTasksList = [];

            // Get filter values (same as Task Tracker)
            const carnivalFilter = document.getElementById('timeline-carnival-filter').value;
            const clubFilter = document.getElementById('timeline-club-filter').value;
            const teamFilter = document.getElementById('timeline-team-filter').value;
            const ownerFilter = document.getElementById('timeline-owner-filter').value;
            const statusFilter = document.getElementById('timeline-status-filter').value;
            const taskTypeFilter = document.getElementById('timeline-task-type').value;

            // Debug: Log filter values
            console.log('üîç FILTER VALUES:');
            console.log('  Team Filter:', teamFilter, '(should be "all" or specific team)');
            console.log('  Owner Filter:', ownerFilter, '(should be "all" or specific owner)');
            console.log('  Status Filter:', statusFilter, '(should be "all" or specific status)');
            console.log('  Carnival Filter:', carnivalFilter, '(should be "all" or specific ID)');
            console.log('  Club Filter:', clubFilter, '(should be "all" or specific ID)');
            console.log('  Task Type Filter:', taskTypeFilter, '(should be "all", "carnival", or "club")');

            // Check for null/undefined filter values
            if (!teamFilter) console.log('‚ö†Ô∏è teamFilter is null/undefined!');
            if (!ownerFilter) console.log('‚ö†Ô∏è ownerFilter is null/undefined!');
            if (!statusFilter) console.log('‚ö†Ô∏è statusFilter is null/undefined!');
            if (!carnivalFilter) console.log('‚ö†Ô∏è carnivalFilter is null/undefined!');
            if (!clubFilter) console.log('‚ö†Ô∏è clubFilter is null/undefined!');
            if (!taskTypeFilter) console.log('‚ö†Ô∏è taskTypeFilter is null/undefined!');

            // Simple filter function (copied from Task Tracker)
            const filterTasks = (tasks) => {
                return tasks.filter(task => {
                    console.log(`üß™ Testing task: "${task.description}"`);
                    console.log(`  Task team: "${task.team}" vs Filter: "${teamFilter}"`);
                    console.log(`  Task owner: "${task.owner}" vs Filter: "${ownerFilter}"`);
                    console.log(`  Task status: "${task.status}" vs Filter: "${statusFilter}"`);

                    if (teamFilter !== 'all' && task.team !== teamFilter) {
                        console.log(`  ‚ùå REJECTED: Team mismatch`);
                        return false;
                    }
                    if (ownerFilter !== 'all' && task.owner !== ownerFilter) {
                        console.log(`  ‚ùå REJECTED: Owner mismatch`);
                        return false;
                    }
                    if (statusFilter !== 'all' && task.status !== statusFilter) {
                        console.log(`  ‚ùå REJECTED: Status mismatch`);
                        return false;
                    }
                    console.log(`  ‚úÖ ACCEPTED: Task passed all filters`);
                    return true;
                });
            };

            // Process each carnival (same structure as Task Tracker)
            console.log('üé™ Processing carnivals:');
            carnivalsList.forEach(carnival => {
                console.log(`  Processing carnival: ${carnival.id} (${carnival.name})`);
                console.log(`  Carnival filter: "${carnivalFilter}"`);
                console.log(`  Type check: carnival.id = ${carnival.id} (${typeof carnival.id}), carnivalFilter = ${carnivalFilter} (${typeof carnivalFilter})`);

                // Apply carnival filter first
                if (carnivalFilter !== 'all' && carnival.id != carnivalFilter) {
                    console.log(`  ‚è≠Ô∏è Skipping carnival ${carnival.id} due to filter`);
                    return;
                }
                console.log(`  ‚úÖ Carnival ${carnival.id} passed filter`);

                const carnivalData = allTasks[carnival.id];
                if (!carnivalData) {
                    console.log(`  ‚ùå No data found for carnival ${carnival.id}`);
                    return;
                }
                console.log(`  ‚úÖ Found carnival data for ${carnival.id}`);

                // Add carnival tasks
                const carnivalTasks = carnivalData.carnivalTasks || [];
                const filteredCarnivalTasks = filterTasks(carnivalTasks);
                filteredCarnivalTasks.forEach(task => {
                    if (taskTypeFilter === 'all' || taskTypeFilter === 'carnival') {
                        allTasksList.push({
                            ...task,
                            carnivalId: carnival.id,
                            carnivalName: carnival.name,
                            clubId: null,
                            clubName: null,
                            taskType: 'carnival'
                        });
                    }
                });

                // Add club tasks (same approach as Task Tracker)
                const clubs = clubsList.filter(club => club.carnivals.includes(carnival.id));
                clubs.forEach(club => {
                    // Apply club filter
                    if (clubFilter !== 'all' && club.id != clubFilter) return;

                    const clubTasks = carnivalData.clubs[club.id] || [];
                    const filteredClubTasks = filterTasks(clubTasks);
                    filteredClubTasks.forEach(task => {
                        if (taskTypeFilter === 'all' || taskTypeFilter === 'club') {
                            allTasksList.push({
                                ...task,
                                carnivalId: carnival.id,
                                carnivalName: carnival.name,
                                clubId: club.id,
                                clubName: club.name,
                                taskType: 'club'
                            });
                        }
                    });
                });
            });

            // Removed personal dashboard viewMode logic - not needed for simple Timeline

            console.log('üéØ Final Results:');
            console.log('  allTasksList.length:', allTasksList.length);
            console.log('  Sample tasks:', allTasksList.slice(0, 2));
            console.log('üîç ===== getFilteredTimelineTasks END =====');

            return allTasksList;
        }

        // Render comprehensive timeline
        function renderTimeline() {
            console.log('üìÖ Rendering Timeline view');
            const container = document.getElementById('timeline-content');
            if (!container) {
                console.error('‚ùå timeline-content container not found!');
                return;
            }

            // Save current filter values before updating dropdowns
            const currentFilters = {
                carnival: document.getElementById('timeline-carnival-filter')?.value,
                club: document.getElementById('timeline-club-filter')?.value,
                team: document.getElementById('timeline-team-filter')?.value,
                owner: document.getElementById('timeline-owner-filter')?.value,
                status: document.getElementById('timeline-status-filter')?.value,
                taskType: document.getElementById('timeline-task-type')?.value
            };

            console.log('üîç About to call updateTimelineDropdowns...');
            try {
                updateTimelineDropdowns();
                console.log('‚úÖ updateTimelineDropdowns completed');

                // Restore filter values after dropdown update
                console.log('üîÑ Restoring filter values:', currentFilters);
                if (currentFilters.carnival && document.getElementById('timeline-carnival-filter')) {
                    document.getElementById('timeline-carnival-filter').value = currentFilters.carnival;
                }
                if (currentFilters.club && document.getElementById('timeline-club-filter')) {
                    document.getElementById('timeline-club-filter').value = currentFilters.club;
                }
                if (currentFilters.team && document.getElementById('timeline-team-filter')) {
                    document.getElementById('timeline-team-filter').value = currentFilters.team;
                }
                if (currentFilters.owner && document.getElementById('timeline-owner-filter')) {
                    document.getElementById('timeline-owner-filter').value = currentFilters.owner;
                }
                if (currentFilters.status && document.getElementById('timeline-status-filter')) {
                    document.getElementById('timeline-status-filter').value = currentFilters.status;
                }
                if (currentFilters.taskType && document.getElementById('timeline-task-type')) {
                    document.getElementById('timeline-task-type').value = currentFilters.taskType;
                }

            } catch (error) {
                console.error('‚ùå Error in updateTimelineDropdowns:', error);
            }

            const filteredTasks = getFilteredTimelineTasks();

            // Update summary stats
            const totalFiltered = filteredTasks.length;
            const completed = filteredTasks.filter(t => t.status === 'Completed').length;
            const completionRate = totalFiltered > 0 ? Math.round((completed / totalFiltered) * 100) : 0;

            const timelineTotalEl = document.getElementById('timeline-total-filtered');
            const timelineUpcomingEl = document.getElementById('timeline-upcoming-week');
            const timelineOverdueEl = document.getElementById('timeline-overdue');
            const timelineCompletionEl = document.getElementById('timeline-completion-rate');

            if (timelineTotalEl) timelineTotalEl.textContent = totalFiltered;
            if (timelineUpcomingEl) timelineUpcomingEl.textContent = filteredTasks.filter(t => t.status === 'pending').length;
            if (timelineOverdueEl) {
                timelineOverdueEl.textContent = filteredTasks.filter(t => {
                    const isCompleted = t.status === 'completed' || t.status === 'Completed' || t.status === 'Done' || t.actualDate;
                    const isOverdue = t.expectedDate && new Date(t.expectedDate) < new Date();
                    return isOverdue && !isCompleted;
                }).length;
            }
            if (timelineCompletionEl) timelineCompletionEl.textContent = completionRate + '%';

            if (totalFiltered === 0) {
                // TEMP DEBUG: Show raw data even if filtered result is empty
                console.log('üö® ZERO TASKS - SHOWING DEBUG INFO');
                container.innerHTML = `<div class="bg-red-50 border border-red-200 p-6 rounded-lg">
                    <h3 class="text-lg font-medium text-red-800 mb-2">DEBUG: No Tasks Found</h3>
                    <p class="text-red-700">Carnivals: ${carnivalsList.length}, AllTasks keys: [${Object.keys(allTasks).join(', ')}]</p>
                    <p class="text-red-700">Check browser console for detailed debug output.</p>
                    <details class="mt-4">
                        <summary class="cursor-pointer font-medium">Raw Data Sample</summary>
                        <pre class="mt-2 text-xs bg-gray-100 p-2 rounded">${JSON.stringify({
                            carnivalsList: carnivalsList,
                            allTasksKeys: Object.keys(allTasks),
                            sampleCarnivalData: allTasks[1] ? 'Found' : 'Missing'
                        }, null, 2)}</pre>
                    </details>
                </div>`;
                return;
            }

            // Always use hierarchical list view
            renderTimelineHierarchicalView(filteredTasks, container);
        }

        function renderTimelineHierarchicalView(tasks, container) {
            // Simplified: No grouping, just show all tasks in a flat list
            const hierarchyFilter = 'simple';
            const sortFilter = document.getElementById('timeline-sort-filter').value;

            // Add timeline information to each task
            const tasksWithTimeline = tasks.map(task => {
                const expectedDate = task.expectedDate ? new Date(task.expectedDate) : null;
                const actualDate = task.actualDate ? new Date(task.actualDate) : null;
                const today = new Date();

                let timelineStatus = '';
                let timelineColor = 'gray';
                let timelineDays = '';

                if (expectedDate) {
                    const daysUntilDue = Math.ceil((expectedDate - today) / (1000 * 60 * 60 * 24));

                    // Check if task is completed (status OR has actual completion date)
                    const isCompleted = task.status === 'Completed' || task.status === 'Done' || task.status === 'completed' || actualDate;

                    if (isCompleted) {
                        if (actualDate && actualDate <= expectedDate) {
                            timelineStatus = '‚úÖ Completed on time';
                            timelineColor = 'green';
                        } else if (actualDate && actualDate > expectedDate) {
                            timelineStatus = '‚ö†Ô∏è Completed late';
                            timelineColor = 'orange';
                        } else {
                            timelineStatus = '‚úÖ Completed';
                            timelineColor = 'green';
                        }
                    } else if (daysUntilDue < 0) {
                        timelineStatus = 'üö® Overdue';
                        timelineColor = 'red';
                        timelineDays = `${Math.abs(daysUntilDue)} days overdue`;
                    } else if (daysUntilDue === 0) {
                        timelineStatus = '‚è∞ Due today';
                        timelineColor = 'red';
                        timelineDays = 'Due today';
                    } else if (daysUntilDue <= 3) {
                        timelineStatus = '‚ö° Due soon';
                        timelineColor = 'orange';
                        timelineDays = `${daysUntilDue} days left`;
                    } else if (daysUntilDue <= 7) {
                        timelineStatus = 'üìÖ Due this week';
                        timelineColor = 'yellow';
                        timelineDays = `${daysUntilDue} days left`;
                    } else {
                        timelineStatus = 'üìÖ Upcoming';
                        timelineColor = 'blue';
                        timelineDays = `${daysUntilDue} days left`;
                    }
                } else {
                    timelineStatus = '‚ùì No due date';
                    timelineColor = 'gray';
                    timelineDays = 'Not scheduled';
                }

                return {
                    ...task,
                    timelineStatus,
                    timelineColor,
                    timelineDays,
                    expectedDate,
                    actualDate
                };
            });

            let groupedTasks = {};

            // Simplified: Show all tasks in a flat list without grouping
            groupedTasks = { 'All Tasks': tasksWithTimeline };

            // Render grouped tasks
            let html = '';
            Object.entries(groupedTasks).forEach(([groupName, groupTasks]) => {
                if (groupTasks.length === 0) return;

                // Sort tasks within group based on sort filter
                groupTasks.sort((a, b) => {
                    switch (sortFilter) {
                        case 'due-date-asc':
                            if (!a.expectedDate && !b.expectedDate) return 0;
                            if (!a.expectedDate) return 1;
                            if (!b.expectedDate) return -1;
                            return a.expectedDate - b.expectedDate;

                        case 'due-date-desc':
                            if (!a.expectedDate && !b.expectedDate) return 0;
                            if (!a.expectedDate) return 1;
                            if (!b.expectedDate) return -1;
                            return b.expectedDate - a.expectedDate;

                        case 'overdue-first':
                            const aOverdue = a.timelineColor === 'red' && a.timelineDays.includes('overdue');
                            const bOverdue = b.timelineColor === 'red' && b.timelineDays.includes('overdue');
                            if (aOverdue && !bOverdue) return -1;
                            if (!aOverdue && bOverdue) return 1;
                            // Fall through to urgency sort for non-overdue tasks

                        case 'completed-last':
                            const aCompleted = a.status === 'Completed' || a.status === 'Done';
                            const bCompleted = b.status === 'Completed' || b.status === 'Done';
                            if (!aCompleted && bCompleted) return -1;
                            if (aCompleted && !bCompleted) return 1;
                            // Fall through to urgency sort for non-completed tasks

                        case 'urgency':
                        default:
                            const urgencyOrder = { 'red': 0, 'orange': 1, 'yellow': 2, 'blue': 3, 'green': 4, 'gray': 5 };
                            return urgencyOrder[a.timelineColor] - urgencyOrder[b.timelineColor];
                    }
                });

                html += `<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">${hierarchyFilter === 'all' ? '' : 'üìã '}${groupName} (${groupTasks.length} tasks)</h3>
                    <div class="space-y-3">
                        ${groupTasks.map(task => renderTimelineTaskCard(task)).join('')}
                    </div>
                </div>`;
            });

            container.innerHTML = html || '<div class="bg-gray-50 p-8 text-center text-gray-500">No tasks found matching the current filters.</div>';
        }

        function groupTasksByProperty(tasks, property, defaultValue = 'Unassigned', sortOrder = null) {
            const groups = {};

            tasks.forEach(task => {
                const value = task[property] || defaultValue;
                if (!groups[value]) {
                    groups[value] = [];
                }
                groups[value].push(task);
            });

            // Sort groups if order is specified
            if (sortOrder) {
                const sortedGroups = {};
                sortOrder.forEach(key => {
                    if (groups[key]) {
                        sortedGroups[key] = groups[key];
                    }
                });
                // Add remaining groups
                Object.keys(groups).forEach(key => {
                    if (!sortedGroups[key]) {
                        sortedGroups[key] = groups[key];
                    }
                });
                return sortedGroups;
            }

            return groups;
        }

        function renderTimelineTaskCard(task) {
            const clubColor = task.clubId ? 'green' : 'purple';

            return `
                <div class="bg-${clubColor}-50 border border-${clubColor}-200 p-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${task.carnivalId}', '${task.clubId}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>

                            <!-- Timeline Information -->
                            <div class="bg-${task.timelineColor}-50 border border-${task.timelineColor}-200 p-2 rounded mb-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-${task.timelineColor}-800">${task.timelineStatus}</span>
                                    <span class="text-xs text-${task.timelineColor}-700">${task.timelineDays}</span>
                                </div>
                                ${task.expectedDate ? `
                                    <div class="text-xs text-${task.timelineColor}-600 mt-1">
                                        üìÖ Expected: ${task.expectedDate.toLocaleDateString()}
                                        ${task.actualDate && (task.status === 'completed' || task.status === 'Done') ?
                                            `‚Ä¢ ‚úÖ Completed: ${task.actualDate.toLocaleDateString()}` : ''}
                                    </div>
                                ` : ''}
                            </div>

                            <div class="flex items-center space-x-2 flex-wrap">
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.owner}</span>
                                <span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">${task.status}</span>
                                <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">${task.carnivalName || 'Template'}</span>
                                ${task.clubName ? `<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">${task.clubName}</span>` : ''}
                            </div>
                        </div>

                        <button onclick="event.stopPropagation(); toggleTaskStatus('${task.id}', '${task.carnivalId}', '${task.clubId}')" class="text-indigo-500 hover:text-indigo-700 p-1 rounded" title="Update Status">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTimelineListView(tasks, container) {
            // Removed personal dashboard logic - not needed

            // Group tasks by carnival and club
            const groupedTasks = {};

            tasks.forEach(task => {
                const carnivalKey = task.carnivalName || 'Template Tasks';
                const clubKey = task.clubName || (task.taskType === 'carnival' ? 'Carnival Level' : 'Global');

                if (!groupedTasks[carnivalKey]) {
                    groupedTasks[carnivalKey] = {};
                }
                if (!groupedTasks[carnivalKey][clubKey]) {
                    groupedTasks[carnivalKey][clubKey] = [];
                }
                groupedTasks[carnivalKey][clubKey].push(task);
            });

            let html = '';
            Object.entries(groupedTasks).forEach(([carnivalName, clubs]) => {
                html += `<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-4">üé™ ${carnivalName}</h3>`;

                Object.entries(clubs).forEach(([clubName, clubTasks]) => {
                    const completedCount = clubTasks.filter(t => t.status === 'completed').length;
                    const totalCount = clubTasks.length;
                    const percentage = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

                    const clubColor = clubTasks[0].taskType === 'carnival' ? 'purple' :
                                     clubTasks[0].taskType === 'template' ? 'blue' : 'green';

                    html += `<div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-lg font-medium text-${clubColor}-700">${clubName}</h4>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">${completedCount}/${totalCount} completed</span>
                                <div class="w-20 bg-gray-200 rounded-full h-2">
                                    <div class="bg-${clubColor}-600 h-2 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-medium text-${clubColor}-600">${percentage}%</span>
                            </div>
                        </div>
                        <div class="space-y-3">`;

                    // Sort tasks by priority and status
                    const sortedTasks = clubTasks.sort((a, b) => {
                        const priorityOrder = { 'urgent': 4, 'high': 3, 'medium': 2, 'low': 1 };
                        const statusOrder = { 'pending': 3, 'in-progress': 2, 'completed': 1 };

                        if (a.priority !== b.priority) {
                            return (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2);
                        }
                        return statusOrder[b.status] - statusOrder[a.status];
                    });

                    sortedTasks.forEach(task => {
                        const statusColor = task.status === 'completed' ? 'green' :
                                          task.status === 'in-progress' ? 'yellow' : 'gray';

                        const priorityColor = task.priority === 'urgent' ? 'red' :
                                             task.priority === 'high' ? 'orange' :
                                             task.priority === 'medium' ? 'blue' : 'gray';

                        html += `<div class="bg-${clubColor}-50 border border-${clubColor}-200 p-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${task.carnivalId}', '${task.clubId}')">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs bg-${priorityColor}-100 text-${priorityColor}-800 px-2 py-1 rounded">${task.priority || 'medium'} priority</span>
                                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.owner}</span>
                                        <span class="text-xs bg-${statusColor}-100 text-${statusColor}-800 px-2 py-1 rounded">${task.status}</span>
                                        ${task.expectedDate ? `<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>` : ''}
                                    </div>
                                </div>
                                <div class="ml-4 flex items-center space-x-2">
                                    <button onclick="event.stopPropagation(); toggleTaskStatus('${task.id}', '${task.carnivalId}', '${task.clubId}')"
                                            class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition-colors">
                                        Update Status
                                    </button>
                                    <button class="text-indigo-500 hover:text-indigo-700 p-1 rounded" title="View Details">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });

                    html += `</div></div>`;
                });

                html += `</div>`;
            });

            container.innerHTML = html;
        }

        function renderPersonalDashboard(tasks, container) {
            const selectedOwner = document.getElementById('personal-owner-select').value;

            if (!selectedOwner) {
                container.innerHTML = `<div class="bg-blue-50 border border-blue-200 p-6 rounded-lg text-center">
                    <h3 class="text-lg font-medium text-blue-800 mb-2">Select Your Name</h3>
                    <p class="text-blue-700">Choose your name from the dropdown above to view your personal task dashboard.</p>
                </div>`;
                return;
            }

            // Filter and categorize tasks
            const pending = tasks.filter(t => t.status === 'pending');
            const inProgress = tasks.filter(t => t.status === 'in-progress');
            const overdue = tasks.filter(t => {
                const isCompleted = t.status === 'completed' || t.status === 'Completed' || t.status === 'Done' || t.actualDate;
                const isOverdue = t.expectedDate && new Date(t.expectedDate) < new Date();
                return isOverdue && !isCompleted;
            });
            const completed = tasks.filter(t => t.status === 'completed');

            let html = `<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-semibold text-indigo-700">üë§ ${selectedOwner}'s Personal Dashboard</h3>
                    <div class="text-sm text-gray-500">${tasks.length} total tasks assigned</div>
                </div>

                <!-- Personal Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-red-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${overdue.length}</div>
                        <div class="text-sm text-red-600">Overdue Tasks</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">${pending.length}</div>
                        <div class="text-sm text-yellow-600">Pending Tasks</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${inProgress.length}</div>
                        <div class="text-sm text-blue-600">In Progress</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${completed.length}</div>
                        <div class="text-sm text-green-600">Completed</div>
                    </div>
                </div>`;

            // Show overdue tasks first
            if (overdue.length > 0) {
                html += `<div class="mb-6">
                    <h4 class="text-lg font-medium text-red-700 mb-3">‚ö†Ô∏è Overdue Tasks (${overdue.length})</h4>
                    <div class="space-y-3">`;

                overdue.forEach(task => {
                    html += `<div class="bg-red-50 border border-red-200 p-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${task.carnivalId}', '${task.clubId}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>
                                    <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${task.team}</span>
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.carnivalName || 'Template'}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); toggleTaskStatus('${task.id}', '${task.carnivalId}', '${task.clubId}')"
                                    class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition-colors">
                                Mark Progress
                            </button>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
            }

            // Show pending and in-progress tasks
            const activeTasks = [...pending, ...inProgress];
            if (activeTasks.length > 0) {
                html += `<div class="mb-6">
                    <h4 class="text-lg font-medium text-blue-700 mb-3">üöÄ Active Tasks (${activeTasks.length})</h4>
                    <div class="space-y-3">`;

                activeTasks.forEach(task => {
                    const bgColor = task.status === 'in-progress' ? 'yellow' : 'blue';
                    html += `<div class="bg-${bgColor}-50 border border-${bgColor}-200 p-4 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openTaskDetails('${task.id}', '${task.carnivalId}', '${task.clubId}')">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800 mb-2">${task.description}</p>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs bg-${bgColor}-100 text-${bgColor}-800 px-2 py-1 rounded">${task.status}</span>
                                    ${task.expectedDate ? `<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">Due: ${task.expectedDate}</span>` : ''}
                                    <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">${task.carnivalName || 'Template'}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); toggleTaskStatus('${task.id}', '${task.carnivalId}', '${task.clubId}')"
                                    class="text-xs bg-white border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition-colors">
                                Update Status
                            </button>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
            }

            html += `</div>`;
            container.innerHTML = html;
        }

        function renderTimelineGanttView(tasks, container) {
            container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow text-center">
                <div class="mb-4">
                    <svg class="w-16 h-16 text-indigo-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V8zm0 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Gantt Chart View</h3>
                <p class="text-gray-600 mb-4">Visual timeline with task dependencies and deadlines</p>
                <p class="text-sm text-gray-500">Coming Soon: Interactive Gantt chart with drag-and-drop scheduling</p>
                <p class="text-sm text-indigo-600 mt-2">${tasks.length} tasks ready for timeline visualization</p>
            </div>`;
        }

        function renderTimelineCalendarView(tasks, container) {
            container.innerHTML = `<div class="bg-white p-8 rounded-lg shadow text-center">
                <div class="mb-4">
                    <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Calendar View</h3>
                <p class="text-gray-600 mb-4">Monthly calendar with task deadlines and milestones</p>
                <p class="text-sm text-gray-500">Coming Soon: Interactive calendar with deadline management</p>
                <p class="text-sm text-green-600 mt-2">${tasks.length} tasks ready for calendar integration</p>
            </div>`;
        }

        // Render dashboard
        function renderDashboard() {
            // Update dashboard dropdowns with current data
            updateDashboardDropdowns();

            // Initialize dashboard sections if not already done
            if (!document.querySelector('#section-overview.border-indigo-500')) {
                showDashboardSection('overview');
            }

            // Render dashboard sections
            renderOverviewSection();
            renderCarnivalMatrix();
            renderAlertsSection();
            updateBasicStats();

            // Continue with existing dashboard logic for backwards compatibility

            // Get filter values
            const carnivalFilter = document.getElementById('dashboard-carnival-filter').value;
            const clubFilter = document.getElementById('dashboard-club-filter').value;
            const teamFilter = document.getElementById('dashboard-team-filter').value;
            const ownerFilter = document.getElementById('dashboard-owner-filter').value;
            const statusFilter = document.getElementById('dashboard-status-filter').value;

            console.log('üìä Dashboard Filters:', { carnival: carnivalFilter, club: clubFilter, team: teamFilter, owner: ownerFilter, status: statusFilter });

            // Get filtered tasks (use same data source as Timeline, without taskTemplate)
            const allTasksFlat = [];

            // Use same data collection logic as Timeline (without taskTemplate)
            Object.keys(allTasks).forEach(carnivalId => {
                const carnival = carnivalsList.find(c => c.id == carnivalId);
                if (!carnival) return;

                const carnivalData = allTasks[carnivalId];
                if (!carnivalData) return;

                // Add carnival tasks
                (carnivalData.carnivalTasks || []).forEach(task => {
                    allTasksFlat.push({
                        ...task,
                        carnivalId: carnival.id,
                        carnivalName: carnival.name,
                        taskType: 'carnival'
                    });
                });

                // Add club tasks
                const clubs = clubsList.filter(club => club.carnivals.includes(carnival.id));
                clubs.forEach(club => {
                    (carnivalData.clubs[club.id] || []).forEach(task => {
                        allTasksFlat.push({
                            ...task,
                            carnivalId: carnival.id,
                            carnivalName: carnival.name,
                            clubId: club.id,
                            clubName: club.name,
                            taskType: 'club'
                        });
                    });
                });
            });

            const filteredTasks = allTasksFlat.filter(task => {
                if (carnivalFilter !== 'all' && task.carnivalId != carnivalFilter) return false;
                if (clubFilter !== 'all' && task.clubId != clubFilter) return false;
                if (teamFilter !== 'all' && task.team !== teamFilter) return false;
                if (ownerFilter !== 'all' && task.owner !== ownerFilter) return false;
                if (statusFilter !== 'all' && task.status !== statusFilter) return false;
                return true;
            });

            const totalTasks = filteredTasks.length;
            const completedTasks = filteredTasks.filter(task => task.status === 'Completed').length; // Fixed: proper case
            const inProgressTasks = filteredTasks.filter(task => task.status === 'In Progress').length; // Fixed: proper case
            const completionPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const totalTasksEl = document.getElementById('total-tasks-stat');
            const completedTasksEl = document.getElementById('completed-tasks-stat');
            const progressTasksEl = document.getElementById('progress-tasks-stat');
            const completionEl = document.getElementById('completion-stat');

            if (totalTasksEl) totalTasksEl.textContent = totalTasks;
            if (completedTasksEl) completedTasksEl.textContent = completedTasks;
            if (progressTasksEl) progressTasksEl.textContent = inProgressTasks;
            if (completionEl) completionEl.textContent = completionPercentage + '%';

            updateAllDropdowns();
        }

        // Legacy edit functions (replaced by enhanced task details modal)
        function editTask(index) {
            const task = taskTemplate[index];
            openTaskDetails(task.id, null, null);
        }

        // Delete task function
        // Transfer Task from Club Level to Carnival Level
        function transferTaskToCarnival(carnivalId, clubId, taskId, taskDescription) {
            if (!confirm(`Transfer "${taskDescription}" from club level to carnival level?\n\nThis will:\n‚Ä¢ Remove the task from ${clubsList.find(c => c.id == clubId)?.name || 'this club'}\n‚Ä¢ Add it as a carnival-level task\n‚Ä¢ Apply to ALL clubs in this carnival\n\nContinue?`)) {
                return;
            }

            try {
                // Find the task in club tasks
                const carnival = allTasks[carnivalId];
                if (!carnival || !carnival.clubs[clubId]) {
                    alert('Club tasks not found.');
                    return;
                }

                const clubTasks = carnival.clubs[clubId];
                const taskIndex = clubTasks.findIndex(task => task.id === taskId);

                if (taskIndex === -1) {
                    alert('Task not found in club.');
                    return;
                }

                const taskToTransfer = clubTasks[taskIndex];

                // Create carnival-level task
                const carnivalTask = {
                    ...taskToTransfer,
                    id: Date.now().toString(),
                    transferredFrom: clubsList.find(c => c.id == clubId)?.name || 'Unknown Club',
                    transferredAt: new Date().toISOString().split('T')[0]
                };

                // Add to carnival-level tasks
                if (!carnival.carnivalTasks) {
                    carnival.carnivalTasks = [];
                }
                carnival.carnivalTasks.push(carnivalTask);

                // Remove from club tasks
                clubTasks.splice(taskIndex, 1);

                // Update UI
                renderTaskTracker();

                alert(`Task "${taskDescription}" transferred to carnival level successfully!\n\nIt now applies to all clubs in this carnival.`);

            } catch (error) {
                console.error("Error transferring task:", error);
                alert("Error transferring task to carnival level.");
            }
        }


        function deleteTask(index) {
            const task = taskTemplate[index];
            const confirmed = confirm('Are you sure you want to delete this mandatory task?\n\n' + task.description + '\n\nThis will affect all future club registrations.');

            if (confirmed) {
                taskTemplate.splice(index, 1);
                renderTaskTemplate();
                updateTemplateCount();
                alert('Mandatory task deleted successfully! You now have ' + taskTemplate.length + ' mandatory tasks.');
            }
        }

        // Enhanced Task Management Functions
        let currentTaskDetails = null;

        function updateProgressDisplay() {
            const progressInput = document.getElementById('task-detail-progress');
            const progressDisplay = document.getElementById('progress-display');
            if (progressInput && progressDisplay) {
                progressDisplay.textContent = progressInput.value + '%';
            }
        }

        function openTaskDetails(taskId, carnivalId, clubId) {
            // Find the task
            let task = null;
            let carnival = null;
            let club = null;

            if (carnivalId === 'null' || !carnivalId) {
                // Template task
                task = taskTemplate.find(t => t.id == taskId);
                currentTaskDetails = { task, location: 'template', carnivalId: null, clubId: null };
            } else if (clubId === 'null' || !clubId) {
                // Carnival task
                task = allTasks[carnivalId]?.carnivalTasks.find(t => t.id == taskId);
                carnival = carnivalsList.find(c => c.id == carnivalId);
                currentTaskDetails = { task, location: 'carnival', carnivalId, clubId: null };
            } else {
                // Club task
                task = allTasks[carnivalId]?.clubs[clubId]?.find(t => t.id == taskId);
                carnival = carnivalsList.find(c => c.id == carnivalId);
                club = clubsList.find(c => c.id == clubId);
                currentTaskDetails = { task, location: 'club', carnivalId, clubId };
            }

            if (!task) {
                alert('Task not found!');
                return;
            }

            // Populate modal fields
            document.getElementById('task-detail-description').value = task.description || '';
            document.getElementById('task-detail-team').value = task.team || 'Operations';
            document.getElementById('task-detail-owner').value = task.owner || '';
            document.getElementById('task-detail-status').value = task.status || 'pending';
            document.getElementById('task-detail-expected-date').value = task.expectedDate || '';
            document.getElementById('task-detail-actual-date').value = task.actualDate || '';
            document.getElementById('task-detail-notes').value = task.notes || '';
            document.getElementById('task-detail-link1').value = task.link1 || '';
            document.getElementById('task-detail-link2').value = task.link2 || '';
            document.getElementById('task-detail-link3').value = task.link3 || '';
            document.getElementById('task-detail-priority').value = task.priority || 'medium';
            document.getElementById('task-detail-progress').value = task.progress || 0;
            updateProgressDisplay();

            // Update context information
            const contextCarnivalEl = document.getElementById('task-context-carnival');
            const contextClubEl = document.getElementById('task-context-club');
            const contextTypeEl = document.getElementById('task-context-type');
            const contextCreatedEl = document.getElementById('task-context-created');

            if (contextCarnivalEl) contextCarnivalEl.textContent = carnival?.name || 'Template Task';
            if (contextClubEl) contextClubEl.textContent = club?.name || (currentTaskDetails.location === 'carnival' ? 'Carnival Level' : '-');
            if (contextTypeEl) contextTypeEl.textContent = currentTaskDetails.location.charAt(0).toUpperCase() + currentTaskDetails.location.slice(1);
            if (contextCreatedEl) contextCreatedEl.textContent = task.createdAt || 'Unknown';

            // Show modal
            document.getElementById('task-details-modal').classList.remove('hidden');
        }

        function closeTaskDetailsModal() {
            document.getElementById('task-details-modal').classList.add('hidden');
            currentTaskDetails = null;
            // Reset transfer options
            document.getElementById('task-transfer-type').value = '';
            document.getElementById('transfer-carnival-section').classList.add('hidden');
            document.getElementById('transfer-club-section').classList.add('hidden');
            document.getElementById('transfer-action-btn').classList.add('hidden');
        }

        // Update transfer options based on selection
        function updateTransferOptions() {
            const transferType = document.getElementById('task-transfer-type').value;
            const carnivalSection = document.getElementById('transfer-carnival-section');
            const clubSection = document.getElementById('transfer-club-section');
            const actionBtn = document.getElementById('transfer-action-btn');

            // Hide all sections initially
            carnivalSection.classList.add('hidden');
            clubSection.classList.add('hidden');
            actionBtn.classList.add('hidden');

            if (!transferType) return;

            // Populate carnival dropdown
            const carnivalSelect = document.getElementById('task-transfer-carnival');
            carnivalSelect.innerHTML = '<option value="">Choose carnival...</option>';
            carnivalsList.forEach(carnival => {
                carnivalSelect.innerHTML += `<option value="${carnival.id}">${carnival.name}</option>`;
            });

            if (transferType === 'template-to-carnival') {
                carnivalSection.classList.remove('hidden');
                actionBtn.classList.remove('hidden');
                actionBtn.textContent = 'Transfer to Carnival Level';
            } else if (transferType === 'club-to-carnival') {
                actionBtn.classList.remove('hidden');
                actionBtn.textContent = 'Transfer to Carnival Level';
            } else if (transferType === 'carnival-to-club') {
                carnivalSection.classList.remove('hidden');
                clubSection.classList.remove('hidden');
                actionBtn.classList.remove('hidden');
                actionBtn.textContent = 'Transfer to Club Level';

                // Set up club selection based on carnival
                carnivalSelect.addEventListener('change', function() {
                    updateClubOptions(this.value);
                });
            } else if (transferType === 'template-to-club') {
                carnivalSection.classList.remove('hidden');
                clubSection.classList.remove('hidden');
                actionBtn.classList.remove('hidden');
                actionBtn.textContent = 'Transfer to Club Level';

                carnivalSelect.addEventListener('change', function() {
                    updateClubOptions(this.value);
                });
            }
        }

        // Update club options based on selected carnival
        function updateClubOptions(carnivalId) {
            const clubSelect = document.getElementById('task-transfer-club');
            clubSelect.innerHTML = '<option value="">Choose club...</option>';

            if (carnivalId) {
                const clubs = clubsList.filter(club => club.carnivals.includes(parseInt(carnivalId)));
                clubSelect.innerHTML += '<option value="all">All Clubs in Carnival</option>';
                clubs.forEach(club => {
                    clubSelect.innerHTML += `<option value="${club.id}">${club.name} (${club.activity})</option>`;
                });
            }
        }

        // Execute the transfer based on current selection
        function executeTaskTransfer() {
            if (!currentTaskDetails) return;

            const transferType = document.getElementById('task-transfer-type').value;
            const carnivalId = document.getElementById('task-transfer-carnival').value;
            const clubId = document.getElementById('task-transfer-club').value;

            const task = currentTaskDetails.task;
            const taskDescription = task.description;

            switch(transferType) {
                case 'template-to-carnival':
                    if (!carnivalId) {
                        alert('Please select a carnival.');
                        return;
                    }
                    transferTemplateToCarnaval(task, carnivalId, taskDescription);
                    break;

                case 'club-to-carnival':
                    transferClubToCarnival(task, taskDescription);
                    break;

                case 'carnival-to-club':
                    if (!carnivalId || !clubId) {
                        alert('Please select both carnival and club.');
                        return;
                    }
                    transferCarnivalToClub(task, carnivalId, clubId, taskDescription);
                    break;

                case 'template-to-club':
                    if (!carnivalId || !clubId) {
                        alert('Please select both carnival and club.');
                        return;
                    }
                    transferTemplateToClub(task, carnivalId, clubId, taskDescription);
                    break;

                default:
                    alert('Please select a transfer option.');
                    return;
            }
        }

        // Transfer functions for different scenarios
        function transferTemplateToCarnaval(task, carnivalId, taskDescription) {
            const carnival = carnivalsList.find(c => c.id == carnivalId);
            if (!carnival) return;

            if (!confirm(`Transfer "${taskDescription}" from template to ${carnival.name}?\n\n‚Ä¢ Removes from mandatory template\n‚Ä¢ Adds to ${carnival.name} carnival level\n‚Ä¢ Applies to all clubs in ${carnival.name}`)) {
                return;
            }

            // Find task index in template
            const taskIndex = taskTemplate.findIndex(t => t.id === task.id);
            if (taskIndex === -1) return;

            // Create carnival task
            const carnivalTask = { ...task, id: Date.now().toString() };

            // Add to carnival
            if (!allTasks[carnivalId]) allTasks[carnivalId] = { carnivalTasks: [], clubs: {} };
            if (!allTasks[carnivalId].carnivalTasks) allTasks[carnivalId].carnivalTasks = [];
            allTasks[carnivalId].carnivalTasks.push(carnivalTask);

            // Remove from template
            taskTemplate.splice(taskIndex, 1);

            closeTaskDetailsModal();
            renderTaskTemplate();
            updateTemplateCount();
            alert(`‚úÖ Task transferred to ${carnival.name} successfully!`);
        }

        function transferClubToCarnival(task, taskDescription) {
            const carnivalId = currentTaskDetails.carnivalId;
            const clubId = currentTaskDetails.clubId;

            if (!carnivalId || !clubId) return;

            const carnival = carnivalsList.find(c => c.id == carnivalId);
            const club = clubsList.find(c => c.id == clubId);

            if (!confirm(`Transfer "${taskDescription}" from ${club?.name} to ${carnival?.name} carnival level?\n\n‚Ä¢ Removes from club\n‚Ä¢ Adds to carnival level\n‚Ä¢ Applies to all clubs in carnival`)) {
                return;
            }

            // Find task in club tasks
            const clubTasks = allTasks[carnivalId]?.clubs?.[clubId] || [];
            const taskIndex = clubTasks.findIndex(t => t.id === task.id);
            if (taskIndex === -1) return;

            // Create carnival task
            const carnivalTask = { ...task, id: Date.now().toString() };

            // Add to carnival level
            if (!allTasks[carnivalId].carnivalTasks) allTasks[carnivalId].carnivalTasks = [];
            allTasks[carnivalId].carnivalTasks.push(carnivalTask);

            // Remove from club
            clubTasks.splice(taskIndex, 1);

            closeTaskDetailsModal();
            renderTaskTracker();
            alert(`‚úÖ Task transferred to carnival level successfully!`);
        }

        function transferCarnivalToClub(task, carnivalId, clubId, taskDescription) {
            const carnival = carnivalsList.find(c => c.id == carnivalId);
            const club = clubsList.find(c => c.id == clubId);

            if (clubId === 'all') {
                // Transfer to all clubs
                if (!confirm(`Transfer "${taskDescription}" from carnival to ALL clubs in ${carnival?.name}?\n\n‚Ä¢ Removes from carnival level\n‚Ä¢ Adds to each club individually`)) {
                    return;
                }

                const clubs = clubsList.filter(c => c.carnivals.includes(parseInt(carnivalId)));
                clubs.forEach(club => {
                    const clubTask = { ...task, id: Date.now() + Math.random().toString() };
                    if (!allTasks[carnivalId].clubs[club.id]) allTasks[carnivalId].clubs[club.id] = [];
                    allTasks[carnivalId].clubs[club.id].push(clubTask);
                });
            } else {
                // Transfer to specific club
                if (!confirm(`Transfer "${taskDescription}" from carnival to ${club?.name}?\n\n‚Ä¢ Removes from carnival level\n‚Ä¢ Adds to ${club?.name} only`)) {
                    return;
                }

                const clubTask = { ...task, id: Date.now().toString() };
                if (!allTasks[carnivalId].clubs[clubId]) allTasks[carnivalId].clubs[clubId] = [];
                allTasks[carnivalId].clubs[clubId].push(clubTask);
            }

            // Remove from carnival level
            const carnivalTasks = allTasks[currentTaskDetails.carnivalId]?.carnivalTasks || [];
            const taskIndex = carnivalTasks.findIndex(t => t.id === task.id);
            if (taskIndex !== -1) {
                carnivalTasks.splice(taskIndex, 1);
            }

            closeTaskDetailsModal();
            renderTaskTracker();
            alert(`‚úÖ Task transferred to club level successfully!`);
        }

        function transferTemplateToClub(task, carnivalId, clubId, taskDescription) {
            const carnival = carnivalsList.find(c => c.id == carnivalId);
            const club = clubsList.find(c => c.id == clubId);

            if (clubId === 'all') {
                if (!confirm(`Transfer "${taskDescription}" from template to ALL clubs in ${carnival?.name}?\n\n‚Ä¢ Removes from template\n‚Ä¢ Adds to each club in ${carnival?.name}`)) {
                    return;
                }

                const clubs = clubsList.filter(c => c.carnivals.includes(parseInt(carnivalId)));
                clubs.forEach(club => {
                    const clubTask = { ...task, id: Date.now() + Math.random().toString() };
                    if (!allTasks[carnivalId]) allTasks[carnivalId] = { carnivalTasks: [], clubs: {} };
                    if (!allTasks[carnivalId].clubs[club.id]) allTasks[carnivalId].clubs[club.id] = [];
                    allTasks[carnivalId].clubs[club.id].push(clubTask);
                });
            } else {
                if (!confirm(`Transfer "${taskDescription}" from template to ${club?.name}?\n\n‚Ä¢ Removes from template\n‚Ä¢ Adds to ${club?.name} only`)) {
                    return;
                }

                const clubTask = { ...task, id: Date.now().toString() };
                if (!allTasks[carnivalId]) allTasks[carnivalId] = { carnivalTasks: [], clubs: {} };
                if (!allTasks[carnivalId].clubs[clubId]) allTasks[carnivalId].clubs[clubId] = [];
                allTasks[carnivalId].clubs[clubId].push(clubTask);
            }

            // Remove from template
            const taskIndex = taskTemplate.findIndex(t => t.id === task.id);
            if (taskIndex !== -1) {
                taskTemplate.splice(taskIndex, 1);
            }

            closeTaskDetailsModal();
            renderTaskTemplate();
            renderTaskTracker();
            updateTemplateCount();
            alert(`‚úÖ Task transferred to club level successfully!`);
        }

        function saveTaskDetails() {
            if (!currentTaskDetails) return;

            const taskId = currentTaskDetails.task.id;
            const carnivalId = currentTaskDetails.carnivalId;
            const clubId = currentTaskDetails.clubId;

            // Get the new date values
            const newExpectedDate = document.getElementById('task-detail-expected-date').value;
            const newActualDate = document.getElementById('task-detail-actual-date').value;

            // Create updated task object with new values
            const updatedTaskData = {
                description: document.getElementById('task-detail-description').value,
                team: document.getElementById('task-detail-team').value,
                owner: document.getElementById('task-detail-owner').value,
                status: document.getElementById('task-detail-status').value,
                expectedDate: newExpectedDate,
                actualDate: newActualDate,
                notes: document.getElementById('task-detail-notes').value,
                link1: document.getElementById('task-detail-link1').value,
                link2: document.getElementById('task-detail-link2').value,
                link3: document.getElementById('task-detail-link3').value,
                priority: document.getElementById('task-detail-priority').value,
                progress: parseInt(document.getElementById('task-detail-progress').value),
                updatedAt: new Date().toLocaleDateString()
            };

            // Find and update the specific task in the correct location
            if (currentTaskDetails.location === 'template') {
                // Update template task
                const taskIndex = taskTemplate.findIndex(t => t.id == taskId);
                if (taskIndex !== -1) {
                    Object.assign(taskTemplate[taskIndex], updatedTaskData);
                }
            } else if (currentTaskDetails.location === 'carnival') {
                // Update carnival task
                const carnivalTasks = allTasks[carnivalId]?.carnivalTasks;
                if (carnivalTasks) {
                    const taskIndex = carnivalTasks.findIndex(t => t.id == taskId);
                    if (taskIndex !== -1) {
                        Object.assign(carnivalTasks[taskIndex], updatedTaskData);
                    }
                }
            } else if (currentTaskDetails.location === 'club') {
                // Update club task - IMPORTANT: Only update the specific club's task
                const clubTasks = allTasks[carnivalId]?.clubs?.[clubId];
                if (clubTasks) {
                    const taskIndex = clubTasks.findIndex(t => t.id == taskId);
                    if (taskIndex !== -1) {
                        Object.assign(clubTasks[taskIndex], updatedTaskData);
                    }
                }
            }

            // Save to Firebase
            saveToFirebase('tasks', allTasks);

            // Update all views
            updateAllDropdowns();
            renderDashboard();
            renderTaskTracker();
            renderTimeline();
            if (templateExpanded) renderTaskTemplate();

            closeTaskDetailsModal();
            alert('Task details saved successfully!');
        }


        // Function to completely reset and rebuild data with proper IDs
        function resetAndFixData() {
            console.log('üîÑ COMPLETELY RESETTING AND FIXING DATA');
            console.log('=========================================');

            // Step 1: Clear all corrupted revenue data
            revenueData = {};
            console.log('‚úÖ Revenue data cleared');

            // Step 2: Reassign club IDs to ensure uniqueness
            console.log('\nüîß Reassigning club IDs...');
            clubsList.forEach((club, index) => {
                const oldId = club.id;
                const newId = index + 1; // 1, 2, 3, 4, 5, 6, 7
                club.id = newId;
                console.log(`Club "${club.name}": ${oldId} ‚Üí ${newId}`);
            });

            // Step 3: Update all task references
            console.log('\nüìã Updating task references...');
            Object.entries(allTasks).forEach(([carnivalId, carnival]) => {
                if (carnival.clubs) {
                    const newClubTasks = {};
                    Object.entries(carnival.clubs).forEach(([oldClubId, tasks]) => {
                        // Find which club this belongs to by matching tasks or use index
                        const club = clubsList.find(c => c.id <= clubsList.length); // Get by new ID
                        if (club && Array.isArray(tasks)) {
                            tasks.forEach(task => {
                                task.clubId = club.id;
                            });
                            newClubTasks[club.id] = tasks;
                        }
                    });
                    carnival.clubs = newClubTasks;
                }
            });

            // Step 4: Set proper nextClubId
            nextClubId = clubsList.length + 1;
            console.log(`\nüìä Set nextClubId to ${nextClubId}`);

            // Step 5: Save everything
            saveToLocalStorage();

            // Step 6: Refresh all views
            renderCarnivalMatrix();
            renderRevenueSection();
            updateBasicStats();
            updateAllDropdowns();

            console.log('\n‚úÖ Data reset complete! All club IDs are now unique.');
            console.log('Final club list:', clubsList.map(club => ({id: club.id, name: club.name})));

            alert('Data has been completely reset with proper club IDs. Revenue data cleared. Please re-add revenue to test.');
        }

        // Function to fix duplicate club IDs
        function fixClubIDs() {
            console.log('üîß FIXING DUPLICATE CLUB IDs');
            console.log('==============================');

            // Check current club IDs
            console.log('Before fix - clubsList:', clubsList.map(club => ({id: club.id, name: club.name})));

            // Create a map to track used IDs and fix duplicates
            const usedIds = new Set();
            let maxId = 0;

            clubsList.forEach((club, index) => {
                maxId = Math.max(maxId, club.id || 0);

                if (usedIds.has(club.id) || club.id === undefined) {
                    const oldId = club.id;
                    const newId = ++maxId;
                    console.log(`üîÑ Fixing club "${club.name}": ${oldId} ‚Üí ${newId}`);

                    // Update the club ID
                    club.id = newId;

                    // Update all references in tasks and revenue data
                    Object.entries(allTasks).forEach(([carnivalId, carnival]) => {
                        if (carnival.clubs && carnival.clubs[oldId]) {
                            carnival.clubs[newId] = carnival.clubs[oldId];
                            delete carnival.clubs[oldId];

                            // Update clubId in tasks
                            carnival.clubs[newId].forEach(task => {
                                task.clubId = newId;
                            });
                        }
                    });

                    // Update revenue data
                    Object.entries(revenueData).forEach(([carnivalId, carnival]) => {
                        if (carnival[oldId]) {
                            carnival[newId] = carnival[oldId];
                            delete carnival[oldId];
                        }
                    });
                } else {
                    console.log(`‚úÖ Club "${club.name}" ID ${club.id} is unique`);
                }

                usedIds.add(club.id);
            });

            // Update nextClubId
            nextClubId = maxId + 1;
            console.log(`üìä Set nextClubId to ${nextClubId}`);

            // Save the fixed data
            saveToLocalStorage();

            console.log('After fix - clubsList:', clubsList.map(club => ({id: club.id, name: club.name})));

            // Refresh views
            renderCarnivalMatrix();
            renderRevenueSection();
            updateBasicStats();
            updateAllDropdowns();

            alert('Club IDs have been fixed! Please test revenue addition now.');
        }

        // Function to clear corrupted data
        function clearCorruptedData() {
            console.log('üßπ CLEARING CORRUPTED DATA');
            console.log('==========================');

            // Clear only revenue data (keep tasks and carnivals)
            revenueData = {};
            localStorage.setItem('revenueData', JSON.stringify(revenueData));

            console.log('‚úÖ Revenue data cleared');
            console.log('üìä Refreshing views...');

            renderCarnivalMatrix();
            renderRevenueSection();
            updateBasicStats();

            alert('Revenue data has been cleared. Please re-enter revenue data.');
        }

        // Function to examine localStorage data directly
        function examineStorageData() {
            console.log('üîç EXAMINING STORAGE DATA DIRECTLY v2.1.11');
            console.log('============================================');

            try {
                const rawRevenue = localStorage.getItem('revenueData');
                const rawTasks = localStorage.getItem('allTasks');

                if (rawRevenue) {
                    const parsed = JSON.parse(rawRevenue);
                    console.log('\nüì¶ RAW REVENUE DATA:');
                    console.log(JSON.stringify(parsed, null, 2));

                    // Check for identical entries
                    const entriesMap = new Map();
                    Object.entries(parsed).forEach(([carnivalId, carnival]) => {
                        Object.entries(carnival || {}).forEach(([clubId, club]) => {
                            if (club && club.entries) {
                                club.entries.forEach(entry => {
                                    const key = JSON.stringify(entry);
                                    if (entriesMap.has(key)) {
                                        console.log(`üö® IDENTICAL ENTRY in multiple clubs!`);
                                        console.log(`  First: Carnival ${entriesMap.get(key).carnival} Club ${entriesMap.get(key).club}`);
                                        console.log(`  Second: Carnival ${carnivalId} Club ${clubId}`);
                                        console.log(`  Entry:`, entry);
                                    } else {
                                        entriesMap.set(key, {carnival: carnivalId, club: clubId});
                                    }
                                });
                            }
                        });
                    });
                }

                if (rawTasks) {
                    const parsed = JSON.parse(rawTasks);
                    console.log('\nüì¶ TASK COUNT BY CARNIVAL/CLUB:');
                    let totalTasks = 0;
                    Object.entries(parsed).forEach(([carnivalId, carnival]) => {
                        let carnivalTotalTasks = 0;
                        if (carnival.carnivalTasks) {
                            carnivalTotalTasks += carnival.carnivalTasks.length;
                        }
                        if (carnival.clubs) {
                            Object.entries(carnival.clubs).forEach(([clubId, tasks]) => {
                                if (Array.isArray(tasks)) {
                                    carnivalTotalTasks += tasks.length;
                                    console.log(`  Carnival ${carnivalId} Club ${clubId}: ${tasks.length} tasks`);
                                }
                            });
                        }
                        console.log(`Carnival ${carnivalId} total: ${carnivalTotalTasks} tasks`);
                        totalTasks += carnivalTotalTasks;
                    });
                    console.log(`\nGRAND TOTAL: ${totalTasks} tasks`);
                }

                console.log('\nüîç CURRENT MEMORY STATE:');
                console.log('revenueData in memory:', revenueData);
                console.log('Are they same?', rawRevenue === JSON.stringify(revenueData));

            } catch (e) {
                console.error('Error examining storage:', e);
            }

            return {localStorage: true};
        }

        // COMPREHENSIVE DEBUG FUNCTION - Find the root cause
        function findDataContamination() {
            console.log('üö® FINDING DATA CONTAMINATION ROOT CAUSE');
            console.log('===============================================');

            console.log('\nüìä 1. REVENUE DATA STRUCTURE:');
            console.log('Raw revenueData:', revenueData);

            // Test for object reference sharing
            console.log('\nüîç 2. TESTING OBJECT REFERENCE SHARING:');
            let refMap = new Map();
            Object.entries(revenueData).forEach(([carnivalId, carnivalData]) => {
                Object.entries(carnivalData).forEach(([clubId, clubData]) => {
                    const objId = Object.prototype.toString.call(clubData) + '_' + JSON.stringify(clubData);
                    if (refMap.has(objId)) {
                        console.log(`‚ö†Ô∏è SHARED REFERENCE DETECTED! Clubs ${refMap.get(objId)} and ${carnivalId}.${clubId} share the same object!`);
                    } else {
                        refMap.set(objId, `${carnivalId}.${clubId}`);
                    }

                    // Check if entries array is shared
                    if (clubData.entries) {
                        const entriesId = clubData.entries.toString();
                        if (refMap.has('entries_' + entriesId)) {
                            console.log(`‚ö†Ô∏è SHARED ENTRIES ARRAY! Clubs ${refMap.get('entries_' + entriesId)} and ${carnivalId}.${clubId} share entries array!`);
                        } else {
                            refMap.set('entries_' + entriesId, `${carnivalId}.${clubId}`);
                        }
                    }
                });
            });

            console.log('\nüè¢ 3. CLUBS LIST STRUCTURE:');
            clubsList.forEach((club, index) => {
                console.log(`Club ${index}: ID=${club.id}, Name="${club.name}", Carnivals=[${club.carnivals}]`);
            });

            console.log('\nüé™ 4. TASKS STRUCTURE:');
            Object.entries(allTasks).forEach(([carnivalId, carnivalData]) => {
                console.log(`\nCarnival ${carnivalId}:`);
                if (carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        console.log(`  Club ${clubId}: ${tasks.length} tasks`);
                        // Check for task reference sharing
                        tasks.forEach(task => {
                            const club = clubsList.find(c => c.id == clubId);
                            console.log(`    Task: ${task.description.substring(0, 30)}... ID=${task.id} Status=${task.status}`);
                        });
                    });
                }
            });

            console.log('\nüßÆ 5. TESTING CALCULATION LOGIC:');
            carnivalsList.forEach(carnival => {
                console.log(`\nCarnival ${carnival.id} (${carnival.name}):`);
                const directRevenue = calculateCarnivalRevenue(carnival.id);
                console.log(`  Direct calculation: ‚Çπ${directRevenue}`);

                const manualTotal = Object.values(revenueData[carnival.id] || {}).reduce((total, club) => total + (club.total || 0), 0);
                console.log(`  Manual calculation: ‚Çπ${manualTotal}`);

                if (directRevenue !== manualTotal) {
                    console.log(`  ‚ö†Ô∏è CALCULATION MISMATCH!`);
                }
            });

            console.log('\nüéØ 6. LIVE RENDER TEST:');
            const assignedClubs = clubsList.filter(club =>
                club.carnivals && club.carnivals.includes(parseInt(1)) // Assuming carnival 1
            );

            assignedClubs.forEach(club => {
                const clubRevenue = revenueData[1]?.[club.id]?.total || 0;
                console.log(`  Club ${club.id} (${club.name}): ‚Çπ${clubRevenue}`);
            });
        }

        // DEBUG FUNCTION - Inspect data structure for shared references
        function debugDataStructure() {
            console.log('üîç DEBUGGING: Data Structure Analysis');
            console.log('=====================================');

            // Check revenue data structure
            console.log('üìä Revenue Data:');
            console.log(JSON.stringify(revenueData, null, 2));

            // Check if revenue objects are shared
            let revenueRefs = new Map();
            Object.entries(revenueData).forEach(([carnivalId, carnivalData]) => {
                Object.entries(carnivalData).forEach(([clubId, clubData]) => {
                    const dataStr = JSON.stringify(clubData);
                    if (revenueRefs.has(dataStr)) {
                        console.log(`‚ö†Ô∏è  Revenue data SHARED between clubs! ${revenueRefs.get(dataStr)} and ${carnivalId}.${clubId}`);
                    } else {
                        revenueRefs.set(dataStr, `${carnivalId}.${clubId}`);
                    }
                });
            });

            // Check task data structure
            console.log('\nüìã Task Data Structure:');
            carnivalsList.forEach(carnival => {
                console.log(`\nüé™ Carnival ${carnival.id} (${carnival.name}):`);
                const carnivalData = allTasks[carnival.id];
                if (carnivalData) {
                    if (carnivalData.carnivalTasks) {
                        console.log(`  Carnival tasks: ${carnivalData.carnivalTasks.length}`);
                    }
                    if (carnivalData.clubs) {
                        Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                            const club = clubsList.find(c => c.id == clubId);
                            console.log(`  üè¢ Club ${clubId} (${club?.name || 'Unknown'}): ${tasks.length} tasks`);

                            // Check for task object sharing
                            tasks.forEach((task, index) => {
                                if (task.description === 'Post event content') {
                                    console.log(`    üìù Task ${index}: ${task.description} - ID: ${task.id} - Status: ${task.status}`);
                                }
                            });
                        });
                    }
                }
            });

            // Check clubsList structure
            console.log('\nüè¢ Club Structure:');
            clubsList.forEach(club => {
                console.log(`  Club ${club.id}: ${club.name} - Carnivals: [${club.carnivals}]`);
            });
        }

        // TEST FUNCTION - Verify task isolation between clubs
        function testTaskIsolation() {
            console.log('üß™ TESTING: Task Isolation Between Clubs');
            console.log('=========================================');

            // Find "Post event content" tasks across all clubs
            let postEventTasks = [];

            carnivalsList.forEach(carnival => {
                const carnivalData = allTasks[carnival.id];
                if (carnivalData && carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        tasks.forEach(task => {
                            if (task.description && task.description.toLowerCase().includes('post event content')) {
                                const club = clubsList.find(c => c.id == clubId);
                                postEventTasks.push({
                                    carnival: carnival.name,
                                    club: club ? club.name : `Club ${clubId}`,
                                    task: task,
                                    location: `allTasks[${carnival.id}].clubs[${clubId}]`
                                });
                            }
                        });
                    });
                }
            });

            console.log(`‚úÖ Found ${postEventTasks.length} "Post event content" tasks:`);
            postEventTasks.forEach((item, index) => {
                console.log(`  ${index + 1}. ${item.carnival} ‚Üí ${item.club}`);
                console.log(`     ID: ${item.task.id}`);
                console.log(`     Status: ${item.task.status || 'pending'}`);
                console.log(`     Owner: ${item.task.owner || 'Not assigned'}`);
            });

            if (postEventTasks.length >= 2) {
                // Test: Modify the first task
                const firstTask = postEventTasks[0];
                console.log('\nüìù TEST: Modifying first task...');
                console.log(`   Before: "${firstTask.task.description}"`);

                // Create a unique test description
                const testDescription = `Post event content - TEST ${Date.now()}`;
                firstTask.task.description = testDescription;

                console.log(`   After: "${firstTask.task.description}"`);

                // Check if other tasks were affected
                console.log('\nüîç Checking other tasks...');
                let isolated = true;
                postEventTasks.slice(1).forEach((item, index) => {
                    if (item.task.description === testDescription) {
                        console.log(`   ‚ùå Task ${index + 2} was ALSO modified! (${item.carnival} ‚Üí ${item.club})`);
                        isolated = false;
                    } else {
                        console.log(`   ‚úÖ Task ${index + 2} remains unchanged (${item.carnival} ‚Üí ${item.club})`);
                    }
                });

                // Restore original description
                firstTask.task.description = "Post event content";

                if (isolated) {
                    console.log('\n‚úÖ SUCCESS: Task updates are properly isolated!');
                } else {
                    console.log('\n‚ùå FAILED: Task updates are affecting multiple clubs!');
                }
            } else {
                console.log('\n‚ö†Ô∏è  Need at least 2 "Post event content" tasks to test isolation');
            }

            console.log('=========================================\n');

            // Also test unique IDs
            console.log('üîç Testing Task ID Uniqueness:');
            const allTaskIds = new Set();
            const duplicateIds = [];

            carnivalsList.forEach(carnival => {
                const carnivalData = allTasks[carnival.id];
                if (carnivalData && carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        tasks.forEach(task => {
                            if (allTaskIds.has(task.id)) {
                                duplicateIds.push(task.id);
                            }
                            allTaskIds.add(task.id);
                        });
                    });
                }
            });

            if (duplicateIds.length > 0) {
                console.log(`‚ùå Found ${duplicateIds.length} duplicate task IDs:`, duplicateIds);
            } else {
                console.log(`‚úÖ All ${allTaskIds.size} task IDs are unique!`);
            }

            return isolated && duplicateIds.length === 0;
        }

        // TEST FUNCTION - Verify no auto-syncing between carnivals
        function testNoAutoSync() {
            console.log('üß™ TESTING: Verifying no auto-sync between carnivals...');

            // Create test carnivals with identical tasks
            const testCarnival1 = {
                id: 'just-dink-it-test',
                name: 'Just Dink It - Test',
                description: 'Test carnival 1'
            };

            const testCarnival2 = {
                id: 'rally-gully-test',
                name: 'Rally Gully - Test',
                description: 'Test carnival 2'
            };

            // Add test carnivals if they don't exist
            if (!carnivalsList.find(c => c.id === testCarnival1.id)) {
                carnivalsList.push(testCarnival1);
            }
            if (!carnivalsList.find(c => c.id === testCarnival2.id)) {
                carnivalsList.push(testCarnival2);
            }

            // Create identical tasks in both carnivals
            const testTask1 = {
                id: 'test-task-1',
                description: 'TEST: Venue booking and confirmation',
                team: 'Operations',
                owner: 'TestUser',
                status: 'pending',
                expectedDate: '2024-12-15',
                actualDate: '',
                createdAt: new Date().toLocaleDateString()
            };

            const testTask2 = {
                id: 'test-task-2',
                description: 'TEST: Venue booking and confirmation', // Same description
                team: 'Operations',
                owner: 'TestUser',
                status: 'pending',
                expectedDate: '2024-12-15',
                actualDate: '',
                createdAt: new Date().toLocaleDateString()
            };

            // Initialize task structures
            if (!allTasks[testCarnival1.id]) allTasks[testCarnival1.id] = {};
            if (!allTasks[testCarnival2.id]) allTasks[testCarnival2.id] = {};

            if (!allTasks[testCarnival1.id]['test-club']) allTasks[testCarnival1.id]['test-club'] = [];
            if (!allTasks[testCarnival2.id]['test-club']) allTasks[testCarnival2.id]['test-club'] = [];

            // Add tasks to both carnivals
            allTasks[testCarnival1.id]['test-club'].push(testTask1);
            allTasks[testCarnival2.id]['test-club'].push(testTask2);

            console.log('‚úÖ Created test tasks in both carnivals:');
            console.log('Just Dink It task:', allTasks[testCarnival1.id]['test-club'][0]);
            console.log('Rally Gully task:', allTasks[testCarnival2.id]['test-club'][0]);

            // Now simulate updating the task in Just Dink It
            console.log('\nüîÑ SIMULATING: Updating task in Just Dink It...');

            const justDinkTask = allTasks[testCarnival1.id]['test-club'][0];
            const originalRallyTask = JSON.parse(JSON.stringify(allTasks[testCarnival2.id]['test-club'][0])); // Deep clone

            // Update Just Dink It task
            justDinkTask.expectedDate = '2024-12-20';
            justDinkTask.actualDate = '2024-12-18';
            justDinkTask.status = 'completed';
            justDinkTask.notes = 'Updated from Just Dink It test';

            console.log('‚úèÔ∏è Updated Just Dink It task:', justDinkTask);

            // Check if Rally Gully task was affected
            const rallyTaskAfter = allTasks[testCarnival2.id]['test-club'][0];

            console.log('\nüîç CHECKING: Rally Gully task after Just Dink It update:');
            console.log('Original Rally Gully task:', originalRallyTask);
            console.log('Rally Gully task after update:', rallyTaskAfter);

            // Verify no changes occurred
            const noChanges = (
                rallyTaskAfter.expectedDate === originalRallyTask.expectedDate &&
                rallyTaskAfter.actualDate === originalRallyTask.actualDate &&
                rallyTaskAfter.status === originalRallyTask.status &&
                rallyTaskAfter.notes === originalRallyTask.notes
            );

            if (noChanges) {
                console.log('\n‚úÖ TEST PASSED: No auto-sync occurred! Rally Gully task was NOT affected.');
                console.log('üìù Test Summary:');
                console.log('- Just Dink It expectedDate:', justDinkTask.expectedDate);
                console.log('- Rally Gully expectedDate:', rallyTaskAfter.expectedDate);
                console.log('- Just Dink It actualDate:', justDinkTask.actualDate);
                console.log('- Rally Gully actualDate:', rallyTaskAfter.actualDate);
                console.log('- Just Dink It status:', justDinkTask.status);
                console.log('- Rally Gully status:', rallyTaskAfter.status);
                alert('‚úÖ TEST PASSED: No auto-syncing between carnivals!\n\nJust Dink It updates do NOT affect Rally Gully tasks.\n\nCheck browser console for detailed test results.');
            } else {
                console.log('\n‚ùå TEST FAILED: Auto-sync detected! Rally Gully task was affected.');
                console.log('üìù Differences detected:');
                if (rallyTaskAfter.expectedDate !== originalRallyTask.expectedDate) console.log('- expectedDate changed!');
                if (rallyTaskAfter.actualDate !== originalRallyTask.actualDate) console.log('- actualDate changed!');
                if (rallyTaskAfter.status !== originalRallyTask.status) console.log('- status changed!');
                if (rallyTaskAfter.notes !== originalRallyTask.notes) console.log('- notes changed!');
                alert('‚ùå TEST FAILED: Auto-syncing still happening!\n\nJust Dink It updates are affecting Rally Gully tasks.\n\nCheck browser console for details.');
            }

            // Clean up test data
            setTimeout(() => {
                console.log('\nüßπ Cleaning up test data...');
                const index1 = carnivalsList.findIndex(c => c.id === testCarnival1.id);
                const index2 = carnivalsList.findIndex(c => c.id === testCarnival2.id);
                if (index1 > -1) carnivalsList.splice(index1, 1);
                if (index2 > -1) carnivalsList.splice(index2, 1);
                delete allTasks[testCarnival1.id];
                delete allTasks[testCarnival2.id];
                console.log('‚úÖ Test cleanup completed.');
            }, 2000);
        }

        function validateTaskDate(dateType) {
            if (!currentTaskDetails || !currentTaskDetails.task) return;

            const task = currentTaskDetails.task;
            const createdDate = task.createdAt ? new Date(task.createdAt) : new Date();
            const inputId = dateType === 'expected' ? 'task-detail-expected-date' : 'task-detail-actual-date';
            const errorId = dateType === 'expected' ? 'expected-date-error' : 'actual-date-error';

            const inputElement = document.getElementById(inputId);
            const errorElement = document.getElementById(errorId);
            const selectedDate = new Date(inputElement.value);

            // Reset border color
            inputElement.classList.remove('border-red-500');
            errorElement.classList.add('hidden');

            // Validate if selected date is before creation date
            if (inputElement.value && selectedDate < createdDate) {
                inputElement.classList.add('border-red-500');
                errorElement.classList.remove('hidden');
                errorElement.textContent = `${dateType === 'expected' ? 'Expected' : 'Actual'} date cannot be before task creation date (${createdDate.toLocaleDateString()})`;

                // Clear the invalid date
                setTimeout(() => {
                    inputElement.value = '';
                    inputElement.classList.remove('border-red-500');
                    errorElement.classList.add('hidden');
                }, 2000);

                return false;
            }

            return true;
        }

        // Expandable Dashboard Functions
        let expandedCarnivals = new Set();
        let revenueData = {}; // Store revenue data: {carnivalId: {clubId: {total: 0, entries: []}}}

        function toggleAllCarnivals() {
            const toggleText = document.getElementById('toggle-all-text');
            const allExpanded = carnivalsList.length > 0 && expandedCarnivals.size === carnivalsList.length;

            if (allExpanded) {
                expandedCarnivals.clear();
                toggleText.textContent = 'Expand All';
            } else {
                carnivalsList.forEach(carnival => expandedCarnivals.add(parseInt(carnival.id)));
                toggleText.textContent = 'Collapse All';
            }
            renderCarnivalMatrix();
        }

        function toggleCarnival(carnivalId) {
            // Convert to number to match carnival IDs in data
            const id = parseInt(carnivalId);

            if (expandedCarnivals.has(id)) {
                expandedCarnivals.delete(id);
            } else {
                expandedCarnivals.add(id);
            }
            renderCarnivalMatrix();
        }

        function renderCarnivalMatrix() {
            const container = document.getElementById('carnival-matrix');
            if (!container) return;

            container.innerHTML = '';

            carnivalsList.forEach(carnival => {
                const isExpanded = expandedCarnivals.has(parseInt(carnival.id));
                const carnivalData = allTasks[carnival.id] || {};
                const carnivalRevenue = calculateCarnivalRevenue(carnival.id);

                // Calculate carnival stats
                let totalTasks = 0;
                let completedTasks = 0;
                let urgentTasks = 0;
                let clubs = 0;
                let clubsWithUrgentTasks = 0;

                // Process carnival-level tasks
                if (carnivalData.carnivalTasks && Array.isArray(carnivalData.carnivalTasks)) {
                    carnivalData.carnivalTasks.forEach(task => {
                        totalTasks++;
                        const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                        if (isCompleted) completedTasks++;

                        // Check urgency (due today or overdue)
                        if (!isCompleted && task.expectedDate) {
                            const dueDate = new Date(task.expectedDate);
                            const today = new Date();
                            const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                            if (daysDiff <= 0) {
                                urgentTasks++;
                            }
                        }
                    });
                }

                // Process club-level tasks
                if (carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        if (Array.isArray(tasks)) {
                            clubs++;
                            let clubHasUrgent = false;
                            tasks.forEach(task => {
                                totalTasks++;
                                const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                                if (isCompleted) completedTasks++;

                                // Check urgency (due today or overdue)
                                if (!isCompleted && task.expectedDate) {
                                    const dueDate = new Date(task.expectedDate);
                                    const today = new Date();
                                    const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                                    if (daysDiff <= 0) {
                                        urgentTasks++;
                                        clubHasUrgent = true;
                                    }
                                }
                            });
                            if (clubHasUrgent) clubsWithUrgentTasks++;
                        }
                    });
                }

                const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                const status = getStatusColor(completionRate, urgentTasks);

                const carnivalBox = document.createElement('div');
                carnivalBox.className = `border-2 rounded-lg transition-all duration-300 ${status.borderColor}`;
                carnivalBox.innerHTML = `
                    <div class="p-4 cursor-pointer hover:bg-gray-50" onclick="toggleCarnival('${carnival.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-4 h-4 rounded-full ${status.dotColor}"></div>
                                <h4 class="text-lg font-semibold text-gray-800">${carnival.name}</h4>
                                <span class="text-xs px-2 py-1 rounded-full ${status.badgeColor}">${status.label}</span>
                                ${urgentTasks > 0 ? `<span class="text-xs px-2 py-1 rounded-full bg-red-100 text-red-700">üö® ${urgentTasks} urgent</span>` : ''}
                            </div>
                            <div class="flex items-center space-x-6">
                                <div class="text-center">
                                    <div class="text-sm text-gray-500">Revenue</div>
                                    <div class="font-bold text-green-600">‚Çπ${carnivalRevenue.toLocaleString()}</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-500">Clubs</div>
                                    <div class="font-bold text-blue-600">${clubs}</div>
                                    ${clubsWithUrgentTasks > 0 ? `<div class="text-xs text-red-600">${clubsWithUrgentTasks} need attention</div>` : ''}
                                </div>
                                <div class="text-center">
                                    <div class="text-sm text-gray-500">Tasks</div>
                                    <div class="font-bold text-indigo-600">${completedTasks}/${totalTasks}</div>
                                    <div class="text-xs text-gray-500">${completionRate}% done</div>
                                </div>
                                <div class="text-gray-400 transform transition-transform ${
                                    isExpanded ? 'rotate-90' : ''
                                }">
                                    ‚ñ∂
                                </div>
                            </div>
                        </div>
                    </div>
                    ${isExpanded ? renderCarnivalDetails(carnival.id) : ''}
                `;

                container.appendChild(carnivalBox);
            });
        }

        function renderCarnivalDetails(carnivalId) {
            const carnivalData = allTasks[carnivalId] || {};
            let html = '<div class="border-t bg-gray-50 p-4">';

            if (!carnivalData.clubs || Object.keys(carnivalData.clubs).length === 0) {
                html += '<div class="text-center py-6 text-gray-500">No clubs or tasks found for this carnival</div>';
                html += '</div>';
                return html;
            }

            // Render clubs with expandable task details
            Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                if (Array.isArray(tasks)) {
                    const club = clubsList.find(c => c.id == clubId) || { name: `Club ${clubId}`, activity: 'Unknown' };
                    const clubRevenue = getClubRevenue(carnivalId, clubId);
                    const completedTasks = tasks.filter(task => task.status === 'completed' || task.status === 'Completed' || task.actualDate);
                    const pendingTasks = tasks.filter(task => !(task.status === 'completed' || task.status === 'Completed' || task.actualDate));
                    const urgentTasks = pendingTasks.filter(task => {
                        if (!task.expectedDate) return false;
                        const dueDate = new Date(task.expectedDate);
                        const today = new Date();
                        return dueDate <= today;
                    });
                    const dueSoonTasks = pendingTasks.filter(task => {
                        if (!task.expectedDate) return false;
                        const dueDate = new Date(task.expectedDate);
                        const today = new Date();
                        const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
                        return daysDiff > 0 && daysDiff <= 3;
                    });

                    const clubExpandKey = `${carnivalId}-${clubId}`;
                    const isClubExpanded = expandedCarnivals.has(clubExpandKey);

                    html += `
                        <div class="bg-white rounded-lg p-4 mb-3 border border-gray-200">
                            <div class="cursor-pointer" onclick="toggleClubDetails('${carnivalId}', '${clubId}')">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="transform transition-transform ${isClubExpanded ? 'rotate-90' : ''}">‚ñ∂</div>
                                        <h5 class="font-medium text-gray-800">${club.name}</h5>
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${club.activity}</span>
                                        ${urgentTasks.length > 0 ? `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded-full">üö® ${urgentTasks.length} urgent</span>` : ''}
                                        ${dueSoonTasks.length > 0 ? `<span class="bg-orange-100 text-orange-700 text-xs px-2 py-1 rounded-full">‚è∞ ${dueSoonTasks.length} due soon</span>` : ''}
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="text-right">
                                            <div class="text-sm text-gray-600">${completedTasks.length}/${tasks.length} tasks</div>
                                            <div class="text-sm font-medium text-green-600">‚Çπ${clubRevenue.toLocaleString()}</div>
                                        </div>
                                        <button onclick="openRevenueModal('${carnivalId}', '${clubId}'); event.stopPropagation();" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs hover:bg-green-200">
                                            + Revenue
                                        </button>
                                    </div>
                                </div>
                            </div>

                            ${isClubExpanded ? `
                                <div class="mt-4 space-y-3 border-t pt-4">
                                    ${urgentTasks.length > 0 ? `
                                        <div>
                                            <h6 class="text-sm font-medium text-red-700 mb-2">üö® Urgent Actions Required (${urgentTasks.length})</h6>
                                            <div class="space-y-2">
                                                ${urgentTasks.map(task => renderTaskAction(task, carnivalId, clubId, 'urgent')).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${dueSoonTasks.length > 0 ? `
                                        <div>
                                            <h6 class="text-sm font-medium text-orange-700 mb-2">‚è∞ Due Soon (${dueSoonTasks.length})</h6>
                                            <div class="space-y-2">
                                                ${dueSoonTasks.map(task => renderTaskAction(task, carnivalId, clubId, 'due-soon')).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${pendingTasks.filter(task => !urgentTasks.includes(task) && !dueSoonTasks.includes(task)).length > 0 ? `
                                        <div>
                                            <h6 class="text-sm font-medium text-gray-700 mb-2">üìã Other Pending Tasks</h6>
                                            <div class="space-y-2">
                                                ${pendingTasks.filter(task => !urgentTasks.includes(task) && !dueSoonTasks.includes(task)).slice(0, 3).map(task => renderTaskAction(task, carnivalId, clubId, 'pending')).join('')}
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${completedTasks.length > 0 ? `
                                        <div>
                                            <h6 class="text-sm font-medium text-green-700 mb-2">‚úÖ Completed (${completedTasks.length})</h6>
                                            <div class="text-xs text-gray-500">
                                                ${completedTasks.slice(0, 2).map(task => `‚Ä¢ ${task.description.substring(0, 40)}...`).join('<br>')}
                                                ${completedTasks.length > 2 ? `<br>‚Ä¢ +${completedTasks.length - 2} more completed tasks` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="mt-2">
                                    <div class="text-sm text-gray-600">
                                        ${urgentTasks.length > 0 ? `üö® ${urgentTasks.length} urgent tasks ‚Ä¢ ` : ''}
                                        ${pendingTasks.length} pending ‚Ä¢ ${completedTasks.length} completed
                                        <span class="text-indigo-600 ml-2">‚ñ∂ Click to expand</span>
                                    </div>
                                </div>
                            `}
                        </div>
                    `;
                }
            });

            html += '</div>';
            return html;
        }

        function toggleClubDetails(carnivalId, clubId) {
            const clubExpandKey = `${carnivalId}-${clubId}`;
            if (expandedCarnivals.has(clubExpandKey)) {
                expandedCarnivals.delete(clubExpandKey);
            } else {
                expandedCarnivals.add(clubExpandKey);
            }
            renderCarnivalMatrix();
        }

        function renderTaskAction(task, carnivalId, clubId, priority) {
            const urgencyInfo = getTaskUrgency(task);
            const priorityClass = priority === 'urgent' ? 'border-red-200 bg-red-50' :
                                 priority === 'due-soon' ? 'border-orange-200 bg-orange-50' :
                                 'border-gray-200 bg-gray-50';

            return `
                <div class="flex items-center justify-between p-3 border rounded-lg ${priorityClass}">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <div class="w-2 h-2 rounded-full ${urgencyInfo.color}"></div>
                            <span class="text-sm font-medium text-gray-800">${task.description}</span>
                        </div>
                        <div class="text-xs text-gray-600">
                            ${task.owner ? `Owner: ${task.owner} ‚Ä¢ ` : ''}
                            ${task.team ? `Team: ${task.team} ‚Ä¢ ` : ''}
                            ${urgencyInfo.label}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-3">
                        <button onclick="markTaskComplete('${task.id}', '${carnivalId}', '${clubId}'); event.stopPropagation();"
                                class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs hover:bg-green-200">
                            ‚úì Complete
                        </button>
                        <button onclick="openTaskDetails('${task.id}', '${carnivalId}', '${clubId}'); event.stopPropagation();"
                                class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200">
                            Edit
                        </button>
                    </div>
                </div>
            `;
        }

        function markTaskComplete(taskId, carnivalId, clubId) {
            const tasks = allTasks[carnivalId]?.[clubId];
            if (!tasks) return;

            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            task.status = 'completed';
            task.actualDate = new Date().toISOString().split('T')[0];
            task.updatedAt = new Date().toLocaleDateString();

            saveToFirebase('tasks', allTasks);
            renderCarnivalMatrix();
            updateBasicStats();

            alert(`‚úÖ Task "${task.description.substring(0, 30)}..." marked as completed!`);
        }

        function renderPriorityTasks(tasks, carnivalId, clubId) {
            const today = new Date();
            const priorityTasks = tasks
                .filter(task => {
                    const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                    return !isCompleted;
                })
                .sort((a, b) => {
                    // Sort by urgency: overdue -> due today -> due soon
                    const aDate = a.expectedDate ? new Date(a.expectedDate) : new Date('2099-12-31');
                    const bDate = b.expectedDate ? new Date(b.expectedDate) : new Date('2099-12-31');
                    return aDate - bDate;
                })
                .slice(0, 3); // Show top 3 priority tasks

            if (priorityTasks.length === 0) {
                return '<div class="text-sm text-gray-500 italic">All tasks completed! üéâ</div>';
            }

            return priorityTasks.map(task => {
                const urgencyInfo = getTaskUrgency(task);
                return `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 rounded-full ${urgencyInfo.color}"></div>
                            <span class="text-gray-700">${task.description.substring(0, 50)}${task.description.length > 50 ? '...' : ''}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">${urgencyInfo.label}</span>
                            <button onclick="openTaskDetails('${task.id}', '${carnivalId}', '${clubId}')" class="text-indigo-600 hover:text-indigo-800 text-xs">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTaskUrgency(task) {
            if (!task.expectedDate) return { color: 'bg-gray-400', label: 'No due date' };

            const dueDate = new Date(task.expectedDate);
            const today = new Date();
            const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

            if (daysDiff < 0) return { color: 'bg-red-500', label: `${Math.abs(daysDiff)}d overdue` };
            if (daysDiff === 0) return { color: 'bg-red-400', label: 'Due today' };
            if (daysDiff <= 2) return { color: 'bg-orange-400', label: `Due in ${daysDiff}d` };
            if (daysDiff <= 7) return { color: 'bg-yellow-400', label: `${daysDiff} days` };
            return { color: 'bg-green-400', label: `${daysDiff} days` };
        }

        function getStatusColor(completionRate, urgentTasks) {
            if (urgentTasks > 0) {
                return {
                    borderColor: 'border-red-300',
                    dotColor: 'bg-red-500',
                    badgeColor: 'bg-red-100 text-red-700',
                    label: 'Critical'
                };
            } else if (completionRate >= 80) {
                return {
                    borderColor: 'border-green-300',
                    dotColor: 'bg-green-500',
                    badgeColor: 'bg-green-100 text-green-700',
                    label: 'On Track'
                };
            } else if (completionRate >= 60) {
                return {
                    borderColor: 'border-yellow-300',
                    dotColor: 'bg-yellow-500',
                    badgeColor: 'bg-yellow-100 text-yellow-700',
                    label: 'At Risk'
                };
            } else {
                return {
                    borderColor: 'border-orange-300',
                    dotColor: 'bg-orange-500',
                    badgeColor: 'bg-orange-100 text-orange-700',
                    label: 'Behind'
                };
            }
        }

        // Revenue Management Functions
        function openRevenueModal(carnivalId, clubId) {
            const carnival = carnivalsList.find(c => c.id === carnivalId);
            document.getElementById('revenue-carnival').value = carnival ? carnival.name : carnivalId;
            document.getElementById('revenue-club').value = clubId;
            document.getElementById('revenue-amount').value = '';
            document.getElementById('revenue-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('revenue-description').value = '';

            // Store current carnival and club for adding revenue
            window.currentRevenueTarget = { carnivalId, clubId };

            document.getElementById('revenue-modal').classList.remove('hidden');
        }

        function closeRevenueModal() {
            document.getElementById('revenue-modal').classList.add('hidden');
            window.currentRevenueTarget = null;
        }

        function addRevenue() {
            if (!window.currentRevenueTarget) return;

            const amount = parseFloat(document.getElementById('revenue-amount').value);
            const date = document.getElementById('revenue-date').value;
            const description = document.getElementById('revenue-description').value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid revenue amount');
                return;
            }

            if (!date) {
                alert('Please select a date');
                return;
            }

            const { carnivalId, clubId } = window.currentRevenueTarget;

            // Initialize revenue data structure
            if (!revenueData[carnivalId]) revenueData[carnivalId] = {};
            if (!revenueData[carnivalId][clubId]) revenueData[carnivalId][clubId] = { total: 0, entries: [] };

            // Add revenue entry
            const revenueEntry = {
                amount,
                date,
                description: description || 'Revenue entry',
                timestamp: new Date().toISOString()
            };

            revenueData[carnivalId][clubId].entries.push(revenueEntry);
            revenueData[carnivalId][clubId].total += amount;

            // Save to Firebase/localStorage
            saveToFirebase('revenue', revenueData);

            console.log(`üí∞ Added ‚Çπ${amount.toLocaleString()} revenue for ${clubId} in ${carnivalId}`);

            closeRevenueModal();
            renderCarnivalMatrix();
            updateBasicStats();

            // Show success message
            alert(`‚úÖ Added ‚Çπ${amount.toLocaleString()} revenue for ${clubId}!`);
        }

        function calculateCarnivalRevenue(carnivalId) {
            if (!revenueData[carnivalId]) return 0;
            return Object.values(revenueData[carnivalId]).reduce((total, club) => total + club.total, 0);
        }

        function getClubRevenue(carnivalId, clubId) {
            return revenueData[carnivalId]?.[clubId]?.total || 0;
        }

        // Revenue Management Functions
        let currentEditingEntry = null;

        function loadRevenueEntries() {
            const carnivalId = document.getElementById('manage-revenue-carnival').value;
            const entriesList = document.getElementById('revenue-entries-list');

            if (!carnivalId) {
                entriesList.innerHTML = '<p class="text-sm text-gray-500">Select a carnival to view revenue entries</p>';
                return;
            }

            if (!revenueData[carnivalId]) {
                entriesList.innerHTML = '<p class="text-sm text-gray-500">No revenue entries found for this carnival</p>';
                return;
            }

            let html = '';
            let totalRevenue = 0;

            Object.entries(revenueData[carnivalId]).forEach(([clubId, clubData]) => {
                const club = clubsList.find(c => c.id == clubId) || { name: `Club ${clubId}` };

                if (clubData.entries && clubData.entries.length > 0) {
                    html += `<div class="bg-gray-50 p-3 rounded-lg">
                        <h5 class="font-medium text-gray-800 mb-2">${club.name}</h5>
                        <div class="space-y-2">`;

                    clubData.entries.forEach((entry, index) => {
                        totalRevenue += entry.amount;
                        const date = new Date(entry.timestamp).toLocaleDateString();
                        html += `
                            <div class="flex items-center justify-between bg-white p-2 rounded border">
                                <div class="flex-1">
                                    <div class="text-sm font-medium">‚Çπ${entry.amount.toLocaleString()}</div>
                                    <div class="text-xs text-gray-600">${entry.description || 'No description'}</div>
                                    <div class="text-xs text-gray-500">${date}</div>
                                </div>
                                <button onclick="openEditRevenueModal('${carnivalId}', '${clubId}', ${index})"
                                        class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs hover:bg-blue-200">
                                    Edit
                                </button>
                            </div>`;
                    });

                    html += `</div></div>`;
                }
            });

            if (html) {
                html = `<div class="mb-3 p-2 bg-green-50 rounded">
                    <strong>Total Revenue: ‚Çπ${totalRevenue.toLocaleString()}</strong>
                </div>` + html;
            } else {
                html = '<p class="text-sm text-gray-500">No revenue entries found for this carnival</p>';
            }

            entriesList.innerHTML = html;
        }

        function openEditRevenueModal(carnivalId, clubId, entryIndex) {
            const entry = revenueData[carnivalId][clubId].entries[entryIndex];
            const club = clubsList.find(c => c.id == clubId) || { name: `Club ${clubId}` };

            currentEditingEntry = { carnivalId, clubId, entryIndex, originalAmount: entry.amount };

            document.getElementById('edit-revenue-amount').value = entry.amount;
            document.getElementById('edit-revenue-description').value = entry.description || '';
            document.getElementById('edit-revenue-club-name').textContent = club.name;
            document.getElementById('edit-revenue-timestamp').textContent = new Date(entry.timestamp).toLocaleString();

            document.getElementById('edit-revenue-modal').classList.remove('hidden');
        }

        function closeEditRevenueModal() {
            document.getElementById('edit-revenue-modal').classList.add('hidden');
            currentEditingEntry = null;
        }

        function saveRevenueEdit() {
            if (!currentEditingEntry) return;

            const newAmount = parseFloat(document.getElementById('edit-revenue-amount').value);
            const newDescription = document.getElementById('edit-revenue-description').value.trim();

            if (!newAmount || newAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            const { carnivalId, clubId, entryIndex, originalAmount } = currentEditingEntry;

            // Update the entry
            revenueData[carnivalId][clubId].entries[entryIndex].amount = newAmount;
            revenueData[carnivalId][clubId].entries[entryIndex].description = newDescription;
            revenueData[carnivalId][clubId].entries[entryIndex].updatedAt = new Date().toISOString();

            // Update the total
            revenueData[carnivalId][clubId].total = revenueData[carnivalId][clubId].total - originalAmount + newAmount;

            // Save to storage
            saveToFirebase('revenue', revenueData);

            // Refresh views
            loadRevenueEntries();
            renderCarnivalMatrix();
            renderRevenueSection();

            closeEditRevenueModal();

            console.log(`‚úèÔ∏è Updated revenue entry: ‚Çπ${newAmount.toLocaleString()}`);
        }

        function deleteRevenueEntry() {
            if (!currentEditingEntry) return;

            if (!confirm('Are you sure you want to delete this revenue entry? This action cannot be undone.')) {
                return;
            }

            const { carnivalId, clubId, entryIndex, originalAmount } = currentEditingEntry;

            // Remove the entry
            revenueData[carnivalId][clubId].entries.splice(entryIndex, 1);

            // Update the total
            revenueData[carnivalId][clubId].total -= originalAmount;

            // Clean up if no entries left
            if (revenueData[carnivalId][clubId].entries.length === 0) {
                revenueData[carnivalId][clubId].total = 0;
            }

            // Save to storage
            saveToFirebase('revenue', revenueData);

            // Refresh views
            loadRevenueEntries();
            renderCarnivalMatrix();
            renderRevenueSection();

            closeEditRevenueModal();

            console.log(`üóëÔ∏è Deleted revenue entry: ‚Çπ${originalAmount.toLocaleString()}`);
        }

        // Dashboard Section Management
        function showDashboardSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active state from all tabs
            document.querySelectorAll('[id^="section-"]').forEach(tab => {
                tab.classList.remove('border-indigo-500', 'text-indigo-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected section
            document.getElementById(`dashboard-section-${sectionName}`).classList.remove('hidden');

            // Activate selected tab
            const activeTab = document.getElementById(`section-${sectionName}`);
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');

            // Render content for the selected section
            switch(sectionName) {
                case 'overview':
                    renderOverviewSection();
                    break;
                case 'carnivals':
                    renderCarnivalMatrix();
                    break;
                case 'revenue':
                    renderRevenueSection();
                    break;
                case 'alerts':
                    renderAlertsSection();
                    break;
            }
        }

        function renderOverviewSection() {
            const carnivalsContainer = document.getElementById('overview-carnivals');
            carnivalsContainer.innerHTML = '';

            // Get current filter values
            const carnivalFilter = document.getElementById('dashboard-carnival-filter')?.value || 'all';
            const clubFilter = document.getElementById('dashboard-club-filter')?.value || 'all';
            const teamFilter = document.getElementById('dashboard-team-filter')?.value || 'all';
            const ownerFilter = document.getElementById('dashboard-owner-filter')?.value || 'all';

            let totalTasks = 0;
            let completedTasks = 0;
            let totalRevenue = 0;
            let urgentTasks = 0;

            carnivalsList.forEach(carnival => {
                // Apply carnival filter
                if (carnivalFilter !== 'all' && carnival.id != carnivalFilter) return;
                const carnivalTasks = allTasks[carnival.id] || {};
                let carnivalTaskCount = 0;
                let carnivalCompleted = 0;
                let carnivalUrgent = 0;

                Object.entries(carnivalTasks).forEach(([clubId, tasks]) => {
                    if (clubId !== 'carnivalTasks' && Array.isArray(tasks)) {
                        // Apply club filter
                        if (clubFilter !== 'all' && !clubId.toLowerCase().includes(clubFilter.toLowerCase())) return;

                        tasks.forEach(task => {
                            // Apply team filter
                            if (teamFilter !== 'all' && task.team !== teamFilter) return;
                            // Apply owner filter
                            if (ownerFilter !== 'all' && task.owner !== ownerFilter) return;
                            carnivalTaskCount++;
                            totalTasks++;
                            const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                            if (isCompleted) {
                                carnivalCompleted++;
                                completedTasks++;
                            }
                            if (!isCompleted && task.expectedDate) {
                                const dueDate = new Date(task.expectedDate);
                                const today = new Date();
                                if (dueDate <= today) {
                                    carnivalUrgent++;
                                    urgentTasks++;
                                }
                            }
                        });
                    }
                });

                const carnivalRevenue = calculateCarnivalRevenue(carnival.id);
                totalRevenue += carnivalRevenue;
                const completionRate = carnivalTaskCount > 0 ? Math.round((carnivalCompleted / carnivalTaskCount) * 100) : 0;

                const statusClass = carnivalUrgent > 0 ? 'text-red-600' :
                                   completionRate >= 80 ? 'text-green-600' :
                                   completionRate >= 60 ? 'text-yellow-600' : 'text-orange-600';

                carnivalsContainer.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <div class="font-medium text-gray-800">${carnival.name}</div>
                            <div class="text-sm text-gray-600">${carnivalCompleted}/${carnivalTaskCount} tasks ‚Ä¢ ${completionRate}% complete</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium ${statusClass}">‚Çπ${carnivalRevenue.toLocaleString()}</div>
                            ${carnivalUrgent > 0 ? `<div class="text-xs text-red-600">${carnivalUrgent} urgent</div>` : ''}
                        </div>
                    </div>
                `;
            });

            // Update summary metrics
            const overviewTotalEl = document.getElementById('overview-total-tasks');
            const overviewCompletionEl = document.getElementById('overview-completion');
            const overviewRevenueEl = document.getElementById('overview-revenue');
            const overviewUrgentEl = document.getElementById('overview-urgent');

            if (overviewTotalEl) overviewTotalEl.textContent = totalTasks;
            if (overviewCompletionEl) overviewCompletionEl.textContent = totalTasks > 0 ? `${Math.round((completedTasks / totalTasks) * 100)}%` : '0%';
            if (overviewRevenueEl) overviewRevenueEl.textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            if (overviewUrgentEl) overviewUrgentEl.textContent = urgentTasks;
        }

        function renderRevenueSection() {
            const container = document.getElementById('revenue-by-carnival');
            container.innerHTML = '';

            carnivalsList.forEach(carnival => {
                const carnivalRevenue = calculateCarnivalRevenue(carnival.id);
                const carnivalData = revenueData[carnival.id] || {};

                // Get clubs assigned to this carnival
                const assignedClubs = clubsList.filter(club =>
                    club.carnivals && club.carnivals.includes(parseInt(carnival.id))
                );

                container.innerHTML += `
                    <div class="border rounded-lg p-4 bg-white shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <h5 class="font-medium text-gray-800">${carnival.name}</h5>
                            <span class="font-bold text-green-600 text-lg">‚Çπ${carnivalRevenue.toLocaleString()}</span>
                        </div>

                        ${Object.keys(carnivalData).length > 0 ? `
                            <div class="space-y-2">
                                <div class="text-xs text-gray-500 font-medium mb-1">Club-wise Breakdown:</div>
                                ${assignedClubs.map(club => {
                                    // Safely get club revenue with better isolation
                                    let clubRevenue = 0;
                                    if (revenueData[carnival.id] && revenueData[carnival.id][club.id] && revenueData[carnival.id][club.id].total) {
                                        clubRevenue = revenueData[carnival.id][club.id].total;
                                    }
                                    const hasRevenue = clubRevenue > 0;

                                    // Debug logging for revenue display
                                    console.log(`üîç Club ${club.id} (${club.name}) revenue: ‚Çπ${clubRevenue} from carnival ${carnival.id}`);

                                    return `
                                        <div class="flex justify-between items-center text-sm ${hasRevenue ? 'bg-green-50' : 'bg-gray-50'} p-2 rounded">
                                            <div class="flex items-center space-x-2">
                                                <span class="${hasRevenue ? 'text-gray-700 font-medium' : 'text-gray-500'}">${club.name}</span>
                                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">${club.activity}</span>
                                                <span class="text-xs text-gray-400">[ID:${club.id}]</span>
                                            </div>
                                            <span class="${hasRevenue ? 'text-green-700 font-medium' : 'text-gray-400'}">‚Çπ${clubRevenue.toLocaleString()}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-sm text-gray-500 italic">
                                No revenue recorded yet
                                ${assignedClubs.length > 0 ? `
                                    <div class="mt-2 text-xs">
                                        <div class="font-medium mb-1">Assigned Clubs:</div>
                                        ${assignedClubs.map(club => `
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="text-gray-600">‚Ä¢ ${club.name}</span>
                                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">${club.activity}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `}
                    </div>
                `;
            });

            // Update quick add dropdowns
            const carnivalSelect = document.getElementById('quick-revenue-carnival');
            carnivalSelect.innerHTML = '<option value="">Select Carnival</option>';
            carnivalsList.forEach(carnival => {
                carnivalSelect.innerHTML += `<option value="${carnival.id}">${carnival.name}</option>`;
            });
        }

        function updateRevenueDropdowns() {
            // Update quick add revenue dropdown
            const quickCarnivalSelect = document.getElementById('quick-revenue-carnival');
            if (quickCarnivalSelect) {
                quickCarnivalSelect.innerHTML = '<option value="">Select Carnival</option>';
                carnivalsList.forEach(carnival => {
                    quickCarnivalSelect.innerHTML += `<option value="${carnival.id}">${carnival.name}</option>`;
                });
            }

            // Update manage revenue dropdown
            const manageCarnivalSelect = document.getElementById('manage-revenue-carnival');
            if (manageCarnivalSelect) {
                const currentValue = manageCarnivalSelect.value; // Preserve selection
                manageCarnivalSelect.innerHTML = '<option value="">Select Carnival</option>';
                carnivalsList.forEach(carnival => {
                    manageCarnivalSelect.innerHTML += `<option value="${carnival.id}">${carnival.name}</option>`;
                });
                if (currentValue) {
                    manageCarnivalSelect.value = currentValue;
                    loadRevenueEntries(); // Refresh the entries if carnival was selected
                }
            }
        }

        function renderAlertsSection() {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '';

            let urgentTasks = [];
            let dueSoonTasks = [];
            let noRevenueCarnvials = [];
            let stuckTasks = [];

            // Collect all priority tasks with full context
            carnivalsList.forEach(carnival => {
                const carnivalData = allTasks[carnival.id] || {};
                const revenue = calculateCarnivalRevenue(carnival.id);

                // Check revenue status
                if (revenue === 0) {
                    noRevenueCarnvials.push(carnival);
                }

                // Process carnival-level tasks
                if (carnivalData.carnivalTasks && Array.isArray(carnivalData.carnivalTasks)) {
                    carnivalData.carnivalTasks.forEach(task => {
                        const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                        if (!isCompleted && task.expectedDate) {
                            const dueDate = new Date(task.expectedDate);
                            const today = new Date();
                            const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

                            const club = clubsList.find(c => c.id == 'carnival-level') || { name: 'Carnival Level' };
                            const taskWithContext = {
                                ...task,
                                carnivalId: carnival.id,
                                carnivalName: carnival.name,
                                clubId: 'carnival-level',
                                clubName: 'Carnival Level',
                                team: task.team || 'Operations',
                                daysDiff: daysDiff
                            };

                            if (daysDiff <= 0) {
                                urgentTasks.push(taskWithContext);
                            } else if (daysDiff <= 3) {
                                dueSoonTasks.push(taskWithContext);
                            }

                            // Check for stuck tasks (in same status for too long)
                            if (task.status === 'pending' && daysDiff <= -7) {
                                stuckTasks.push(taskWithContext);
                            }
                        }
                    });
                }

                // Process club-level tasks
                if (carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        if (Array.isArray(tasks)) {
                            const club = clubsList.find(c => c.id == clubId) || { name: `Club ${clubId}` };
                            tasks.forEach(task => {
                                const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                                if (!isCompleted && task.expectedDate) {
                                    const dueDate = new Date(task.expectedDate);
                                    const today = new Date();
                                    const daysDiff = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));

                                    const taskWithContext = {
                                        ...task,
                                        carnivalId: carnival.id,
                                        carnivalName: carnival.name,
                                        clubId: clubId,
                                        clubName: club.name,
                                        team: task.team || 'Operations',
                                        daysDiff: daysDiff
                                    };

                                if (daysDiff <= 0) {
                                    urgentTasks.push(taskWithContext);
                                } else if (daysDiff <= 3) {
                                    dueSoonTasks.push(taskWithContext);
                                }

                                // Check for stuck tasks (pending for more than 7 days without updates)
                                const createdDate = new Date(task.createdAt || new Date());
                                const daysSinceCreated = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));
                                if (daysSinceCreated > 7 && task.status === 'pending') {
                                    stuckTasks.push(taskWithContext);
                                }
                            }
                        });
                        }
                    });
                }
            });

            // Sort by urgency
            urgentTasks.sort((a, b) => a.daysDiff - b.daysDiff); // Most overdue first
            dueSoonTasks.sort((a, b) => a.daysDiff - b.daysDiff); // Soonest due first

            let html = '';

            // Render urgent tasks section
            if (urgentTasks.length > 0) {
                html += `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-red-800">üö® Urgent: ${urgentTasks.length} Overdue Tasks</h4>
                            <button onclick="markAllUrgentComplete()" class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200">
                                Bulk Actions
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${urgentTasks.slice(0, 5).map(task => renderPriorityTaskAlert(task, 'urgent')).join('')}
                            ${urgentTasks.length > 5 ? `<div class="text-xs text-red-600 text-center pt-2">+${urgentTasks.length - 5} more urgent tasks...</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Render due soon tasks
            if (dueSoonTasks.length > 0) {
                html += `
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-orange-800 mb-3">‚è∞ Due Soon: ${dueSoonTasks.length} Tasks</h4>
                        <div class="space-y-3">
                            ${dueSoonTasks.slice(0, 3).map(task => renderPriorityTaskAlert(task, 'due-soon')).join('')}
                            ${dueSoonTasks.length > 3 ? `<div class="text-xs text-orange-600 text-center pt-2">+${dueSoonTasks.length - 3} more due soon...</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Render stuck tasks
            if (stuckTasks.length > 0) {
                html += `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-yellow-800 mb-3">‚åõ Stuck: ${stuckTasks.length} Tasks Need Attention</h4>
                        <div class="space-y-3">
                            ${stuckTasks.slice(0, 3).map(task => renderPriorityTaskAlert(task, 'stuck')).join('')}
                            ${stuckTasks.length > 3 ? `<div class="text-xs text-yellow-600 text-center pt-2">+${stuckTasks.length - 3} more stuck tasks...</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // Render revenue alerts
            if (noRevenueCarnvials.length > 0) {
                html += `
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-blue-800 mb-3">üí∞ Revenue: ${noRevenueCarnvials.length} Carnivals Need Revenue Tracking</h4>
                        <div class="space-y-2">
                            ${noRevenueCarnvials.map(carnival => `
                                <div class="flex items-center justify-between p-2 bg-white rounded border">
                                    <span class="text-sm text-gray-700">${carnival.name}</span>
                                    <button onclick="showDashboardSection('revenue')" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200">
                                        Add Revenue
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (html === '') {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">All Clear!</h3>
                        <p class="text-gray-600">No urgent tasks or alerts at this time. Everything is on track!</p>
                    </div>
                `;
            } else {
                container.innerHTML = html;
            }
        }

        function renderPriorityTaskAlert(task, priority) {
            const priorityConfig = {
                'urgent': {
                    bgClass: 'bg-white border-red-200',
                    textClass: 'text-red-700',
                    icon: 'üö®',
                    label: `${Math.abs(task.daysDiff)} days overdue`
                },
                'due-soon': {
                    bgClass: 'bg-white border-orange-200',
                    textClass: 'text-orange-700',
                    icon: '‚è∞',
                    label: `Due in ${task.daysDiff} days`
                },
                'stuck': {
                    bgClass: 'bg-white border-yellow-200',
                    textClass: 'text-yellow-700',
                    icon: '‚åõ',
                    label: 'No progress'
                }
            };

            const config = priorityConfig[priority];

            return `
                <div class="border rounded-lg p-3 ${config.bgClass}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-sm">${config.icon}</span>
                                <span class="text-sm font-medium text-gray-800">${task.description}</span>
                            </div>
                            <div class="text-xs text-gray-600 mb-2">
                                <span class="font-medium">${task.carnivalName}</span> ‚Ä¢
                                <span>${task.clubName || task.clubId}</span> ‚Ä¢
                                <span class="${config.textClass}">${config.label}</span>
                            </div>
                            <div class="text-xs text-gray-500">
                                ${task.team ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded mr-2">${task.team}</span>` : ''}
                                ${task.owner ? `Owner: ${task.owner}` : 'No owner assigned'}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 ml-3">
                            <button onclick="quickCompleteTask('${task.id}', '${task.carnivalId}', '${task.clubId}')"
                                    class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs hover:bg-green-200">
                                ‚úì Complete
                            </button>
                            <button onclick="openTaskDetails('${task.id}', '${task.carnivalId}', '${task.clubId}')"
                                    class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-xs hover:bg-gray-200">
                                Edit
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function quickCompleteTask(taskId, carnivalId, clubId) {
            markTaskComplete(taskId, carnivalId, clubId);
            // Refresh alerts section
            renderAlertsSection();
        }

        function quickAddRevenue() {
            const carnivalId = document.getElementById('quick-revenue-carnival').value;
            const clubId = document.getElementById('quick-revenue-club').value;
            const amount = parseFloat(document.getElementById('quick-revenue-amount').value);

            if (!carnivalId || !clubId || !amount) {
                alert('Please fill all fields');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            // Initialize revenue data structure with proper isolation
            if (!revenueData[carnivalId]) {
                revenueData[carnivalId] = {};
            }
            if (!revenueData[carnivalId][clubId]) {
                revenueData[carnivalId][clubId] = {
                    total: 0,
                    entries: []
                };
            }

            // Add revenue entry with better tracking
            const revenueEntry = {
                id: `rev_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                amount: amount,
                date: new Date().toISOString().split('T')[0],
                description: 'Quick add revenue',
                timestamp: new Date().toISOString(),
                clubId: clubId,
                carnivalId: carnivalId
            };

            // Ensure we're updating the correct club's data
            const targetClub = revenueData[carnivalId][clubId];
            targetClub.entries.push(revenueEntry);
            targetClub.total = (targetClub.total || 0) + amount;

            // Save to Firebase/localStorage
            saveToFirebase('revenue', revenueData);

            console.log(`üí∞ Quick added ‚Çπ${amount.toLocaleString()} revenue for club ${clubId} (${clubsList.find(c => c.id == clubId)?.name}) in carnival ${carnivalId}`);
            console.log(`üìä Club ${clubId} new total: ‚Çπ${targetClub.total.toLocaleString()}`);

            // Clear form
            document.getElementById('quick-revenue-amount').value = '';

            // Refresh views
            renderCarnivalMatrix();
            renderRevenueSection();
            updateBasicStats();

            alert(`‚úÖ Added ‚Çπ${amount.toLocaleString()} revenue successfully!`);
        }

        function updateClubDropdown() {
            const carnivalId = document.getElementById('quick-revenue-carnival').value;
            const clubSelect = document.getElementById('quick-revenue-club');

            clubSelect.innerHTML = '<option value="">Select Club</option>';

            if (carnivalId) {
                // Show all clubs assigned to this carnival (based on club.carnivals array)
                const assignedClubs = clubsList.filter(club =>
                    club.carnivals && club.carnivals.includes(parseInt(carnivalId))
                );

                assignedClubs.forEach(club => {
                    clubSelect.innerHTML += `<option value="${club.id}">${club.name}</option>`;
                });
            }
        }

        function updateBasicStats() {
            // Calculate basic dashboard stats
            let totalTasks = 0;
            let completedTasks = 0;
            let totalRevenue = 0;

            carnivalsList.forEach(carnival => {
                const carnivalData = allTasks[carnival.id] || {};

                // Count carnival-level tasks
                if (carnivalData.carnivalTasks && Array.isArray(carnivalData.carnivalTasks)) {
                    carnivalData.carnivalTasks.forEach(task => {
                        totalTasks++;
                        const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                        if (isCompleted) completedTasks++;
                    });
                }

                // Count club-level tasks
                if (carnivalData.clubs) {
                    Object.entries(carnivalData.clubs).forEach(([clubId, tasks]) => {
                        if (Array.isArray(tasks)) {
                            tasks.forEach(task => {
                                totalTasks++;
                                const isCompleted = task.status === 'completed' || task.status === 'Completed' || task.actualDate;
                                if (isCompleted) completedTasks++;
                            });
                        }
                    });
                }

                totalRevenue += calculateCarnivalRevenue(carnival.id);
            });

            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const totalTasksStatEl = document.getElementById('total-tasks-stat');
            const completedTasksStatEl = document.getElementById('completed-tasks-stat');
            const totalRevenueStatEl = document.getElementById('total-revenue-stat');
            const completionStatEl = document.getElementById('completion-stat');

            if (totalTasksStatEl) totalTasksStatEl.textContent = totalTasks;
            if (completedTasksStatEl) completedTasksStatEl.textContent = completedTasks;
            if (totalRevenueStatEl) totalRevenueStatEl.textContent = `‚Çπ${totalRevenue.toLocaleString()}`;
            if (completionStatEl) completionStatEl.textContent = `${completionRate}%`;
        }

        function deleteCurrentTask() {
            if (!currentTaskDetails) return;

            const confirmed = confirm('Are you sure you want to delete this task?\n\n' + currentTaskDetails.task.description);
            if (!confirmed) return;

            if (currentTaskDetails.location === 'template') {
                // Remove from template
                const index = taskTemplate.findIndex(t => t.id === currentTaskDetails.task.id);
                if (index > -1) {
                    taskTemplate.splice(index, 1);
                }
            } else if (currentTaskDetails.location === 'carnival') {
                // Remove carnival task
                const carnivalTasks = allTasks[currentTaskDetails.carnivalId].carnivalTasks;
                const index = carnivalTasks.findIndex(t => t.id === currentTaskDetails.task.id);
                if (index > -1) {
                    carnivalTasks.splice(index, 1);
                }
            } else if (currentTaskDetails.location === 'club') {
                // Remove club task
                const clubTasks = allTasks[currentTaskDetails.carnivalId].clubs[currentTaskDetails.clubId];
                const index = clubTasks.findIndex(t => t.id === currentTaskDetails.task.id);
                if (index > -1) {
                    clubTasks.splice(index, 1);
                }
            }

            // Update all views
            updateAllDropdowns();
            renderDashboard();
            renderTaskTracker();
            renderTimeline();
            if (templateExpanded) renderTaskTemplate();

            closeTaskDetailsModal();
            alert('Task deleted successfully!');
        }

        // Toggle task status function for timeline
        function toggleTaskStatus(taskId, carnivalId, clubId) {
            // Find and update the task status
            let task = null;
            let location = '';

            if (carnivalId === 'null' || !carnivalId) {
                // Template task
                task = taskTemplate.find(t => t.id == taskId);
                location = 'template';
            } else if (clubId === 'null' || !clubId) {
                // Carnival task
                task = allTasks[carnivalId]?.carnivalTasks.find(t => t.id == taskId);
                location = 'carnival';
            } else {
                // Club task
                task = allTasks[carnivalId]?.clubs[clubId]?.find(t => t.id == taskId);
                location = 'club';
            }

            if (!task) {
                alert('Task not found!');
                return;
            }

            // Cycle through statuses
            const statusOptions = ['pending', 'in-progress', 'completed'];
            const currentIndex = statusOptions.indexOf(task.status);
            const nextIndex = (currentIndex + 1) % statusOptions.length;
            task.status = statusOptions[nextIndex];

            // Save to Firebase
            saveToFirebase('tasks', allTasks);

            // Update all views
            renderTimeline();
            renderDashboard();

            alert(`Task status updated to: ${task.status}`);
        }

        // Test function to manually trigger dropdown updates
        window.debugTimelineDropdowns = function() {
            console.log('üß™ Manual debug of timeline dropdowns...');
            console.log('Carnivals:', carnivalsList.length);
            console.log('Clubs:', clubsList.length);
            console.log('AllTasks keys:', Object.keys(allTasks));
            updateTimelineDropdowns();
        };

        // Initialize dummy test data if available
        function loadTestDataIfAvailable() {
            const testData = localStorage.getItem('carnivalManagerTestData');
            if (testData) {
                try {
                    const data = JSON.parse(testData);

                    // Load carnivals
                    if (data.carnivals) {
                        data.carnivals.forEach(carnival => {
                            carnivalsList.push(carnival);
                            nextCarnivalId = Math.max(nextCarnivalId, carnival.id + 1);
                            allTasks[carnival.id] = { carnivalTasks: [], clubs: {} };

                            // Add sample carnival tasks
                            const carnivalTasks = [
                                { description: "Deciding the fest name which is deciding the carnival name", team: "Operations", owner: "Joy", status: "completed", id: Date.now() + Math.random() },
                                { description: "Announcement to leaders group", team: "Operations", owner: "Joy", status: "in-progress", id: Date.now() + Math.random() + 1 },
                                { description: "Budget planning for " + carnival.name, team: "Finance", owner: "Tauheed", status: "pending", id: Date.now() + Math.random() + 2, expectedDate: "2025-01-20", priority: "high" }
                            ];
                            allTasks[carnival.id].carnivalTasks = carnivalTasks;
                        });
                    }

                    // Load clubs
                    if (data.clubs) {
                        data.clubs.forEach(club => {
                            clubsList.push(club);
                            nextClubId = Math.max(nextClubId, club.id + 1);

                            // Create tasks for each carnival the club is part of
                            club.carnivals.forEach(carnivalId => {
                                if (!allTasks[carnivalId].clubs[club.id]) {
                                    allTasks[carnivalId].clubs[club.id] = [];
                                }

                                // Create enhanced copies of template tasks
                                const clubTasks = taskTemplate.map((task, index) => {
                                    const enhancedTask = {
                                        ...task,
                                        id: Date.now() + Math.random() + index,
                                        clubId: club.id,
                                        carnivalId: carnivalId
                                    };

                                    // Add sample enhanced data to some tasks
                                    if (index < 5) {
                                        enhancedTask.expectedDate = new Date(Date.now() + (index * 7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0];
                                        enhancedTask.priority = index < 2 ? 'high' : 'medium';
                                        enhancedTask.progress = Math.floor(Math.random() * 100);

                                        if (index === 0) {
                                            enhancedTask.status = 'completed';
                                            enhancedTask.actualDate = enhancedTask.expectedDate;
                                            enhancedTask.notes = 'Completed successfully with venue confirmed.';
                                            enhancedTask.link1 = 'https://docs.google.com/document/venue-contract';
                                        } else if (index === 1) {
                                            enhancedTask.status = 'in-progress';
                                            enhancedTask.notes = 'Working on final details, 75% complete.';
                                            enhancedTask.link1 = 'https://drive.google.com/venue-photos';
                                        }

                                        // Create some overdue tasks for testing
                                        if (index === 2) {
                                            enhancedTask.expectedDate = '2025-01-05'; // Overdue
                                            enhancedTask.priority = 'urgent';
                                            enhancedTask.notes = 'This task is overdue and needs immediate attention!';
                                        }
                                    }

                                    return enhancedTask;
                                });

                                allTasks[carnivalId].clubs[club.id] = clubTasks;
                            });
                        });
                    }

                    console.log('‚úÖ Test data loaded successfully!');
                    console.log('Carnivals:', carnivalsList.length);
                    console.log('Clubs:', clubsList.length);
                    console.log('Total tasks created:', Object.values(allTasks).reduce((total, carnival) => {
                        return total + carnival.carnivalTasks.length + Object.values(carnival.clubs).reduce((clubTotal, tasks) => clubTotal + tasks.length, 0);
                    }, 0));

                    // Clear test data to prevent re-loading
                    localStorage.removeItem('carnivalManagerTestData');

                } catch (e) {
                    console.error('Error loading test data:', e);
                }
            }
        }

        // Function removed - Firebase-only mode

        // Initialize on page load
        window.onload = function() {
            console.log('Misfits Carnival Manager loaded');
            console.log('Template tasks:', taskTemplate.length);

            // Clear all localStorage to force Firebase-only mode
            console.log('üßπ Clearing localStorage to ensure Firebase-only mode');
            localStorage.removeItem('carnivalsList');
            localStorage.removeItem('clubsList');
            localStorage.removeItem('allTasks');
            localStorage.removeItem('revenueData');
            localStorage.removeItem('carnivalManagerTestData');
            localStorage.clear(); // Clear everything to be safe

            // Initialize revenue data with proper isolation
            revenueData = revenueData || {};

            // Firebase-only mode for all environments
            console.log('üî• Firebase-only mode - initializing...');

            // Initialize empty data
            initializeSampleData();

            // Initialize Firebase for all environments
            initializeFirebase();

            updateAllDropdowns();
            renderDashboard();

        };
    </script>
</body>
</html>